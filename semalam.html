<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KawanChat ‚Äî Real-time Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <style>
    :root{
      --kawanchat-blue:#0A5FAD;
      --kawanchat-light:#1C8EED;
      --kawanchat-bubble:#D1E7F9;
      --kawanchat-bg:#F0F2F5;
    }
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:var(--kawanchat-bg);margin:0;display:flex;align-items:center;justify-content:center;min-height:100vh;}
    .app{width:100%;max-width:500px;height:100vh;background:white;box-shadow:0 8px 30px rgba(0,0,0,.15);display:flex;flex-direction:column;position:relative;overflow:hidden;}
    .header{background:var(--kawanchat-blue);color:white;padding:14px}
    .tabbar{display:flex;background:var(--kawanchat-light);color:#f0f6ff}
    .tabbar button{flex:1;padding:10px;font-weight:600;border:none;background:transparent;color:rgba(255,255,255,.85)}
    .tabbar button.active{border-bottom:3px solid white;color:white}
    .stage{display:none;flex-direction:column;align-items:center;justify-content:center;padding:24px;height:100%}
    .stage.active{display:flex}
    .typing{min-height:44px}
    .chat-list,.contacts-list{overflow:auto}
    .chat-bubble{max-width:80%;padding:8px 12px;border-radius:15px;margin-bottom:8px;word-wrap:break-word}
    .sent{background:var(--kawanchat-bubble);align-self:flex-end;border-bottom-right-radius:4px}
    .recv{background:#fff;border:1px solid #eee;align-self:flex-start;border-bottom-left-radius:4px}
    #new-chat-fab{position:absolute;right:18px;bottom:18px;z-index:30;display:none}
    .notif{position:fixed;right:20px;bottom:20px;background:#16a34a;color:white;padding:10px 14px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.15);z-index:60}
    /* simple scroll container heights */
    .flex-grow-scroll{flex:1;display:flex;flex-direction:column;min-height:0}
    .scroll{overflow:auto}
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- STAGES -->
    <div id="loading-stage" class="stage active">
      <i class="fas fa-sync fa-spin text-3xl text-kawanchat-blue mb-4"></i>
      <div class="text-gray-600">Memuat KawanChat...</div>
    </div>

    <div id="welcome-stage" class="stage">
      <h2 class="text-3xl font-bold text-kawanchat-blue mb-4">üëã KawanChat</h2>
      <div id="sapaan-content" class="typing text-lg text-gray-700 max-w-xs text-center mb-6"></div>

      <div id="tos" class="hidden w-full max-w-xs p-3 bg-gray-50 rounded">
        <label class="flex items-center space-x-2 cursor-pointer">
          <input id="agree-tos" type="checkbox" class="h-5 w-5 text-kawanchat-blue"/>
          <span class="text-sm text-gray-600">Saya setuju Persyaratan & Ketentuan KawanChat.</span>
        </label>
      </div>

      <button id="welcome-next" class="mt-6 w-full max-w-xs py-3 rounded text-white font-bold" style="background:var(--kawanchat-blue)" disabled>Lanjut</button>
    </div>

    <div id="registration-stage" class="stage">
      <div class="typing text-xl font-bold text-gray-800 mb-4" id="reg-typing"></div>

      <div id="name-area" class="w-full max-w-xs hidden space-y-3">
        <input id="reg-first" placeholder="Nama Depan" class="w-full p-3 border rounded" />
        <div id="name-feedback" class="text-gray-600 text-sm min-h-[20px]"></div>
        <input id="reg-last" placeholder="Nama Belakang (Opsional)" class="w-full p-3 border rounded" />
        <select id="reg-gender" class="w-full p-3 border rounded">
          <option value="">Pilih Jenis Kelamin</option>
          <option value="L">Laki-laki</option>
          <option value="P">Perempuan</option>
          <option value="O">Lainnya</option>
        </select>
      </div>

      <div id="phone-area" class="w-full max-w-xs hidden space-y-3">
        <div class="flex items-center">
          <span id="phone-emoji" class="mr-3 text-2xl">üôç‚Äç‚ôÇÔ∏è</span>
          <div class="flex-1">
            <div class="flex border p-0 rounded overflow-hidden">
              <span class="px-3 flex items-center">+62</span>
              <input id="reg-phone" placeholder="812345678" class="flex-1 p-3 border-none outline-none" />
            </div>
            <div class="text-sm text-gray-500 mt-1">Contoh: 812345678 (tanpa 0 di depan)</div>
          </div>
        </div>
      </div>

      <div id="final-area" class="w-full max-w-xs hidden text-center text-kawanchat-blue font-semibold min-h-[44px]"></div>

      <button id="reg-next" class="mt-6 w-full max-w-xs py-3 rounded text-white font-bold" style="background:var(--kawanchat-blue)">Selanjutnya</button>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hidden flex flex-col h-full">
      <header class="header flex items-center justify-between">
        <div>
          <div class="text-sm opacity-75">KawanChat</div>
          <div id="display-name" class="text-xs opacity-90"></div>
        </div>
        <div class="text-sm opacity-90">ID: <span id="display-id" class="font-mono"></span></div>
      </header>

      <nav class="tabbar">
        <button class="active" data-tab="chat-tab">OBROLAN</button>
        <button data-tab="status-tab">STATUS</button>
        <button data-tab="calls-tab">PANGGILAN</button>
        <button data-tab="contacts-tab">KONTAK</button>
      </nav>

      <main class="flex-grow-scroll">
        <!-- CHAT TAB -->
        <section id="chat-tab" class="tab-content flex flex-col flex-1 p-3">
          <div class="flex-1 flex overflow-hidden">
            <div id="active-chats" class="w-1/3 bg-white rounded p-2 mr-2 scroll"></div>
            <div class="flex-1 bg-kawanchat-bg p-3 rounded flex flex-col">
              <div id="chat-header" class="flex items-center justify-between mb-3">
                <div id="chat-with" class="font-semibold text-lg text-gray-700">Pilih kontak untuk mulai chat</div>
                <div id="chat-actions" class="text-sm text-gray-500"></div>
              </div>
              <div id="messages" class="flex-1 scroll p-2 flex flex-col"></div>
              <div id="message-area" class="mt-3 hidden items-center">
                <input id="message-input" class="flex-1 p-3 rounded-full border bg-white outline-none" placeholder="Ketik pesan..." />
                <button id="send-btn" class="ml-2 px-3 py-2 rounded-full text-white" style="background:var(--kawanchat-blue)"><i class="fas fa-paper-plane"></i></button>
              </div>
            </div>
          </div>
        </section>

        <!-- STATUS -->
        <section id="status-tab" class="tab-content hidden p-6 text-center">
          <i class="fas fa-circle-notch text-4xl text-gray-400 mb-4"></i>
          <div class="text-gray-600">Fitur Status belum diimplementasikan.</div>
        </section>

        <!-- CALLS -->
        <section id="calls-tab" class="tab-content hidden p-6 text-center">
          <i class="fas fa-phone-alt text-4xl text-gray-400 mb-4"></i>
          <div class="text-gray-600">Fitur Panggilan belum diimplementasikan.</div>
        </section>

        <!-- CONTACTS -->
        <section id="contacts-tab" class="tab-content hidden p-4">
          <h3 class="font-semibold text-kawanchat-blue mb-3">Tambah Kontak</h3>
          <div class="flex mb-3">
            <input id="new-contact-input" placeholder="Masukkan ID pengguna (8 char atau UID)" class="flex-1 p-2 border rounded-l" />
            <button id="add-contact-btn" class="bg-kawanchat-blue text-white px-4 rounded-r">Tambah</button>
          </div>
          <h4 class="font-semibold mb-2">Daftar Kontak</h4>
          <div id="contacts-list" class="contacts-list scroll h-72 p-2 bg-white rounded"></div>
        </section>
      </main>

      <!-- Floating add-contact button on chat tab -->
      <button id="new-chat-fab" title="Tambah kontak" class="bg-kawanchat-blue text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg">
        <i class="fas fa-user-plus"></i>
      </button>
    </div>
  </div>

  <!-- Firebase + App Script -->
  <script type="module">
    // Firebase imports (v12 modules via CDN)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, serverTimestamp, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // --- Firebase Config (user provided) ---
    const firebaseConfig = {
      apiKey: "AIzaSyD9tO94PdmXnqSH4cMVLPbgcEyY1J266mQ",
      authDomain: "whatsapp-clone-web-9418e.firebaseapp.com",
      projectId: "whatsapp-clone-web-9418e",
      storageBucket: "whatsapp-clone-web-9418e.firebasestorage.app",
      messagingSenderId: "31927689655",
      appId: "1:31927689655:web:3e4da24d4237a7ffb08832",
      measurementId: "G-5624HP8XEX"
    };

    // init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // App state
    const appId = 'kawanchat-v1';
    let currentUserId = null;
    let currentUserName = null;
    let currentChatContact = null;
    let unsubscribeMessages = null;
    let contactsUnsub = null;

    // DOM
    const loadingStage = document.getElementById('loading-stage');
    const welcomeStage = document.getElementById('welcome-stage');
    const registrationStage = document.getElementById('registration-stage');
    const mainApp = document.getElementById('main-app');

    const sapaanContent = document.getElementById('sapaan-content');
    const welcomeNextBtn = document.getElementById('welcome-next');
    const tosBox = document.getElementById('tos');
    const agreeTos = document.getElementById('agree-tos');

    const regTyping = document.getElementById('reg-typing');
    const nameArea = document.getElementById('name-area');
    const regFirst = document.getElementById('reg-first');
    const regLast = document.getElementById('reg-last');
    const nameFeedback = document.getElementById('name-feedback');
    const regGender = document.getElementById('reg-gender');

    const phoneArea = document.getElementById('phone-area');
    const phoneEmoji = document.getElementById('phone-emoji');
    const regPhone = document.getElementById('reg-phone');

    const finalArea = document.getElementById('final-area');
    const regNextBtn = document.getElementById('reg-next');

    const displayNameEl = document.getElementById('display-name');
    const displayIdEl = document.getElementById('display-id');

    const tabs = document.querySelectorAll('.tabbar button');
    const tabContents = document.querySelectorAll('.tab-content');
    const newChatFab = document.getElementById('new-chat-fab');

    // Chat DOM
    const activeChats = document.getElementById('active-chats');
    const messagesEl = document.getElementById('messages');
    const chatWithEl = document.getElementById('chat-with');
    const messageArea = document.getElementById('message-area');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    // Contacts
    const contactsList = document.getElementById('contacts-list');
    const newContactInput = document.getElementById('new-contact-input');
    const addContactBtn = document.getElementById('add-contact-btn');

    // onboarding texts
    const sapaanTexts = [
      "Selamat datang di KawanChat! üëã",
      "Di KawanChat kamu bisa chat dengan teman lama maupun teman baru. Serasa gampang antar negara! üåê",
      "KawanChat adalah tempat yang aman untuk berbagi cerita. üîí",
      "Persahabatan sejati dimulai dari pesan sederhana. Mari kita mulai! üí¨"
    ];
    let sapaanStep = 0;

    // utilities
    const setStage = (id) => {
      [loadingStage, welcomeStage, registrationStage, mainApp].forEach(s => s.classList.remove('active'));
      [loadingStage, welcomeStage, registrationStage, mainApp].forEach(s => s.classList.add('hidden'));
      const target = document.getElementById(id);
      if (target) { target.classList.remove('hidden'); target.classList.add('active'); }
    };

    const typeText = (el, text, speed = 30) => {
      return new Promise(res => {
        el.textContent = '';
        let i = 0;
        const t = setInterval(() => {
          if (i < text.length) { el.textContent += text.charAt(i); i++; } else { clearInterval(t); res(); }
        }, speed);
      });
    };

    const showNotif = (txt) => {
      const n = document.createElement('div'); n.className='notif'; n.textContent = txt;
      document.body.appendChild(n);
      setTimeout(()=> n.remove(), 3000);
    };

    // --- Onboarding flow handlers ---
    const nextSapaan = async () => {
      welcomeNextBtn.disabled = true;
      if (sapaanStep < sapaanTexts.length) {
        await typeText(sapaanContent, sapaanTexts[sapaanStep]);
        sapaanStep++;
        welcomeNextBtn.disabled = false;
      } else if (sapaanStep === sapaanTexts.length) {
        await typeText(sapaanContent, "Satu langkah lagi! Silakan setujui persyaratan kami untuk melanjutkan:");
        tosBox.classList.remove('hidden');
        welcomeNextBtn.disabled = !agreeTos.checked;
        sapaanStep++;
      } else {
        // go register
        setStage('registration-stage');
        startRegistration();
      }
    };
    agreeTos.addEventListener('change', () => welcomeNextBtn.disabled = !agreeTos.checked);
    welcomeNextBtn.addEventListener('click', nextSapaan);

    // Registration steps
    let regStep = 1;
    const startRegistration = async () => {
      regNextBtn.disabled = true;
      await regStep1();
    };

    const regStep1 = async () => {
      nameArea.classList.add('hidden');
      phoneArea.classList.add('hidden');
      finalArea.classList.add('hidden');
      await typeText(regTyping, "Kita belum kenalan nih! Kenalan dulu yuk! üôã");
      nameArea.classList.remove('hidden');
      regFirst.focus();
      regStep = 1;
      const nameHandler = () => {
        const name = regFirst.value.trim();
        if (name.length > 0) {
          nameFeedback.textContent = "Hmm kalo nama belakang boleh tau? (opsional)";
          regNextBtn.disabled = false;
        } else {
          nameFeedback.textContent = "";
          regNextBtn.disabled = true;
        }
      };
      regFirst.addEventListener('input', nameHandler, { once: false });
      regNextBtn.onclick = () => {
        regFirst.removeEventListener('input', nameHandler);
        if (regFirst.value.trim()) regStep2();
      };
    };

    const regStep2 = async () => {
      nameArea.classList.add('hidden');
      regStep = 2;
      currentUserName = (regFirst.value.trim() + (regLast.value.trim() ? ' '+regLast.value.trim() : '')).trim();
      await typeText(regTyping, `Yey kita udh kenalan! Hi ${regFirst.value.trim()} üôå`);
      await new Promise(r => setTimeout(r, 800));
      await typeText(regTyping, "Hmm boleh minta nomor mu untuk masuk ke dalam KawanChat? üìû");
      phoneArea.classList.remove('hidden');
      regPhone.focus();

      const focusFn = () => phoneEmoji.textContent = 'ü§¶‚Äç‚ôÇÔ∏è';
      const blurFn = () => phoneEmoji.textContent = 'üôç‚Äç‚ôÇÔ∏è';
      regPhone.addEventListener('focus', focusFn);
      regPhone.addEventListener('blur', blurFn);

      const phoneHandler = () => regNextBtn.disabled = regPhone.value.replace(/\D/g,'').length < 8;
      regPhone.addEventListener('input', phoneHandler);
      regNextBtn.onclick = () => {
        regPhone.removeEventListener('input', phoneHandler);
        regPhone.removeEventListener('focus', focusFn);
        regPhone.removeEventListener('blur', blurFn);
        if (regPhone.value.replace(/\D/g,'').length >= 8) regStep3();
      };
    };

    const signInAndSave = async (displayName, chatID, phoneVal) => {
      // use anon user already signed in
      const user = auth.currentUser;
      if (!user) throw new Error('User not authenticated');
      await updateProfile(user, { displayName });
      const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
      await setDoc(userDocRef, {
        name: displayName,
        id: chatID,
        phone: phoneVal,
        gender: regGender.value || '',
        createdAt: serverTimestamp()
      }, { merge: true });
      currentUserId = user.uid;
      currentUserName = displayName;
    };

    const regStep3 = async () => {
      phoneArea.classList.add('hidden');
      regNextBtn.classList.add('hidden');

      const phoneRaw = regPhone.value.replace(/[^0-9]/g,'');
      const full = '62' + phoneRaw.replace(/^0+/, '');
      await typeText(regTyping, `Nomormu cantik banget ‚ú® kita ambil dari depan nomor mu yah!`);
      await new Promise(r => setTimeout(r,800));

      const mockID = full.padEnd(11,'0');
      const prefix = mockID.substring(0,5);
      await typeText(regTyping, `Oke nomor depan mu ${prefix} kita tambahin jadi ${mockID}!`);
      await new Promise(r => setTimeout(r,900));

      const finalID = mockID.substring(mockID.length - 6);
      await typeText(regTyping, `Yey! ID mu udh di buat! Ini dia: ${finalID} üéâ`);
      await new Promise(r => setTimeout(r,900));

      // sign in should already be done (anon), save profile
      try {
        await signInAndSave(currentUserName || regFirst.value.trim(), finalID, regPhone.value);
      } catch (err) {
        console.error('save profile err', err);
      }

      await typeText(regTyping, `Selamat datang di KawanChat, ${ (currentUserName||regFirst.value.trim()).split(' ')[0]}!`);
      await new Promise(r => setTimeout(r,900));

      // go main app
      setStage('main-app');
      initMainApp();
    };

    // --- Firebase Auth init & onAuthState ---
    const initializeAuth = async () => {
      try {
        await signInAnonymously(auth);
      } catch (err) {
        console.error("Gagal signInAnon:", err);
        setStage('welcome-stage');
        sapaanContent.textContent = "Error: Gagal terhubung ke server Firebase.";
        welcomeNextBtn.disabled = true;
      }
    };

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        await initializeAuth();
        return;
      }
      // If user exists, check doc
      const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
      const snap = await getDoc(userDocRef);
      if (snap.exists()) {
        // existing user -> go main
        currentUserId = user.uid;
        currentUserName = user.displayName || snap.data().name;
        displayNameEl.textContent = currentUserName || 'Teman';
        displayIdEl.textContent = currentUserId.substring(0,8);
        setStage('main-app');
        initMainApp();
      } else {
        // new -> start onboarding
        setStage('welcome-stage');
        // start first sapaan
        sapaanStep = 0;
        nextSapaan();
      }
    });

    // --- MAIN APP functions ---
    const initMainApp = async () => {
      displayNameEl.textContent = currentUserName || 'Teman';
      displayIdEl.textContent = currentUserId ? currentUserId.substring(0,8) : '';
      bindTabs();
      newChatFab.style.display = 'block';
      loadContactsRealtime();
      loadActiveChatsRealtime();
    };

    // Tabs
    function bindTabs(){
      tabs.forEach(btn => {
        btn.addEventListener('click', () => {
          tabs.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          tabContents.forEach(tc => tc.classList.add('hidden'));
          const id = btn.getAttribute('data-tab');
          document.getElementById(id).classList.remove('hidden');
          // show/hide FAB & message area depending on tab
          if (id === 'chat-tab') {
            newChatFab.style.display = 'block';
          } else {
            newChatFab.style.display = 'none';
          }
        });
      });
    }

    // Real-time contacts list
    const loadContactsRealtime = async () => {
      if (!currentUserId) return;
      const cPath = collection(db, `artifacts/${appId}/users/${currentUserId}/contacts`);
      if (contactsUnsub) contactsUnsub();
      contactsUnsub = onSnapshot(cPath, (snap) => {
        contactsList.innerHTML = '';
        activeChats.innerHTML = '';
        if (snap.empty) {
          contactsList.innerHTML = '<div class="text-gray-500 p-2 italic">Belum ada kontak.</div>';
          activeChats.innerHTML = '<div class="text-gray-500 p-2 italic">Klik tombol + untuk tambah kontak.</div>';
        } else {
          snap.forEach(docSnap => {
            const id = docSnap.id;
            const data = docSnap.data();
            // contacts tab
            const row = document.createElement('div');
            row.className = 'p-2 border-b flex items-center justify-between';
            const left = document.createElement('div');
            left.innerHTML = `<div class="font-semibold">${data.name||id.substring(0,8)}</div><div class="text-xs text-gray-400">ID: ${id}</div>`;
            const btn = document.createElement('button');
            btn.className = 'text-sm bg-kawanchat-blue text-white px-3 py-1 rounded';
            btn.textContent = 'Chat';
            btn.onclick = () => startPrivateChat(id, data.name||id.substring(0,8));
            row.appendChild(left);
            row.appendChild(btn);
            contactsList.appendChild(row);

            // active chats list
            const ac = document.createElement('div');
            ac.className = 'p-2 mb-2 bg-white rounded cursor-pointer';
            ac.textContent = `${data.name||id.substring(0,8)} ‚Äî ID:${id}`;
            ac.onclick = () => startPrivateChat(id, data.name||id.substring(0,8));
            activeChats.appendChild(ac);
          });
        }
      }, (e) => console.error("contacts snapshot err", e));
    };

    // Active chats realtime: (list is populated from contacts above), so this is optional placeholder
    const loadActiveChatsRealtime = () => {
      // Already derived from contacts snapshot; additional last-message tracking can be added later
    };

    // Start private chat (set up message listener)
    const startPrivateChat = (contactId, contactName) => {
      currentChatContact = contactId;
      chatWithEl.textContent = contactName;
      messagesEl.innerHTML = '';
      messageArea.classList.remove('hidden');
      messageInput.value = '';
      // unsubscribe previous messages
      if (unsubscribeMessages) unsubscribeMessages();
      // messages stored at: /artifacts/kawanchat-v1/private/chats/<sorted a_b>/messages
      const chatRoomId = [currentUserId, contactId].sort().join('_');
      const messagesPath = collection(db, `artifacts/${appId}/private/chats/${chatRoomId}/messages`);
      const q = query(messagesPath, orderBy('timestamp','asc'));
      unsubscribeMessages = onSnapshot(q, (snap) => {
        const msgs = [];
        snap.forEach(d => msgs.push({ id: d.id, ...d.data() }));
        renderMessages(msgs);
      }, e => {
        console.error("messages snapshot err", e);
      });
      // switch to chat tab (if not already)
      document.querySelector('.tabbar button[data-tab="chat-tab"]').click();
    };

    const renderMessages = (messages) => {
      messagesEl.innerHTML = '';
      if (!messages.length) {
        messagesEl.innerHTML = `<div class="text-center text-gray-500 p-4">Awal dari obrolan dengan ${chatWithEl.textContent}.</div>`;
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return;
      }
      messages.forEach(m => {
        const el = document.createElement('div');
        el.className = 'chat-bubble ' + (m.senderId === currentUserId ? 'sent self-end' : 'recv self-start');
        el.style.alignSelf = (m.senderId === currentUserId) ? 'flex-end' : 'flex-start';
        el.innerHTML = `<div class="text-xs font-semibold ${m.senderId===currentUserId?'text-gray-700':'text-kawanchat-blue'} mb-1">${m.senderName|| (m.senderId===currentUserId?currentUserName:'Teman')}</div>
                        <div class="text-sm">${m.text}</div>
                        <div class="text-xs text-gray-400 mt-1" style="text-align:right">${m.timestamp ? new Date(m.timestamp.toDate ? m.timestamp.toDate() : m.timestamp).toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'}) : '...'}</div>`;
        messagesEl.appendChild(el);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    };

    // Send message
    const sendMessage = async (text) => {
      if (!text.trim() || !currentChatContact || !currentUserId) return;
      try {
        const chatRoomId = [currentUserId, currentChatContact].sort().join('_');
        const path = collection(db, `artifacts/${appId}/private/chats/${chatRoomId}/messages`);
        await addDoc(path, {
          text: text.trim(),
          timestamp: serverTimestamp(),
          senderId: currentUserId,
          senderName: currentUserName || '',
          type: 'text'
        });
        messageInput.value = '';
      } catch (err) {
        console.error('sendMessage err', err);
      }
    };

    // Add contact (two-way)
    addContactBtn.addEventListener('click', async () => {
      const newId = newContactInput.value.trim();
      if (!newId) return alert('Masukkan ID kontak.');
      if (newId === currentUserId) return alert('Tidak bisa menambahkan diri sendiri.');
      try {
        const path1 = doc(db, `artifacts/${appId}/users/${currentUserId}/contacts/${newId}`);
        const path2 = doc(db, `artifacts/${appId}/users/${newId}/contacts/${currentUserId}`);
        await setDoc(path1, { name: newId.substring(0,8), addedAt: serverTimestamp() }, { merge: true });
        await setDoc(path2, { name: currentUserId.substring(0,8), addedAt: serverTimestamp() }, { merge: true });
        showNotif(`Kontak ${newId} berhasil ditambahkan!`);
        newContactInput.value = '';
      } catch (err) {
        console.error('addContact err', err);
        alert('Gagal menambahkan kontak. Pastikan ID benar & pengguna ada.');
      }
    });

    // Floating FAB click -> go to contacts tab
    newChatFab.addEventListener('click', () => {
      document.querySelector('.tabbar button[data-tab="contacts-tab"]').click();
      newContactInput.focus();
    });

    // send button & enter key
    sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage(messageInput.value);
    });

    // initial display: hide message area until a chat opened (already hidden by default)

    // On page load: start auth
    window.addEventListener('load', () => {
      // show loading briefly then init auth
      setTimeout(() => {
        setStage('loading-stage');
        initializeAuth();
      }, 300);
    });

    // small helper: observe when main-app becomes active to ensure FAB visibility
    // (no-op, UI already managed by tab clicks)
  </script>
</body>
</html>
