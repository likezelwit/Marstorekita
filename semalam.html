<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Clone (Real-time Chat)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for WhatsApp look and feel */
        :root {
            --whatsapp-green: #075E54;
            --whatsapp-light-green: #128C7E;
            --whatsapp-bubble: #DCF8C6;
            --whatsapp-bg: #ECE5DD;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--whatsapp-bg);
        }
        .header {
            background-color: var(--whatsapp-green);
        }
        .tab-bar {
            background-color: var(--whatsapp-light-green);
        }
        .tab-bar button.active {
            border-bottom: 3px solid white;
            color: white;
            font-weight: 600;
        }
        .message-input-area {
            background-color: #f0f0f0;
        }
        .chat-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .sent {
            background-color: var(--whatsapp-bubble);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .received {
            background-color: #ffffff;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        /* Mobile optimization */
        .app-container {
            height: 100vh;
            max-width: 500px;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        /* Style for the Contact ID list */
        .contact-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .contact-item:hover {
            background-color: #f5f5f5;
        }
        .scroll-container {
            overflow-y: auto;
            flex-grow: 1;
        }
    </style>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="bg-gray-100">
    <div class="app-container bg-white">
        <!-- HEADER -->
        <header class="header text-white p-4 flex flex-col">
            <div class="flex justify-between items-center mb-2">
                <h1 id="app-title" class="text-xl font-bold">WhatsApp</h1>
                <div class="flex space-x-4 text-lg">
                    <i class="fas fa-search"></i>
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </div>
            <p id="user-id-display" class="text-xs text-gray-200"></p>
        </header>

        <!-- TAB NAVIGATION -->
        <nav class="tab-bar flex justify-between px-2 text-gray-300 shadow-md">
            <button class="flex-1 py-3 text-sm tab-link active" data-tab="chat">CHATS</button>
            <button class="flex-1 py-3 text-sm tab-link" data-tab="status">STATUS</button>
            <button class="flex-1 py-3 text-sm tab-link" data-tab="calls">PANGGILAN</button>
            <button class="flex-1 py-3 text-sm tab-link" data-tab="contacts">KONTAK</button>
        </nav>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-grow scroll-container p-4">

            <!-- CHAT TAB CONTENT -->
            <div id="chat-tab" class="tab-content active h-full flex flex-col">
                <div id="messages-container" class="scroll-container flex flex-col p-2 space-y-2 mb-4 bg-gray-50 rounded-lg">
                    <!-- Messages will be loaded here -->
                    <div class="text-center text-gray-500 p-4">Memuat pesan...</div>
                </div>
                
                <!-- MESSAGE INPUT AREA -->
                <div class="message-input-area p-3 flex items-center rounded-2xl shadow-inner">
                    <button id="emoji-button" class="text-xl text-gray-600 mr-2"><i class="far fa-smile"></i></button>
                    <input type="text" id="message-input" placeholder="Ketik pesan..." class="flex-grow p-3 rounded-full border-none focus:ring-green-500 focus:border-green-500">
                    <button id="send-button" class="ml-2 w-10 h-10 bg-whatsapp-light-green text-white rounded-full flex items-center justify-center shadow-lg hover:bg-whatsapp-green transition duration-150">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

            <!-- CONTACTS TAB CONTENT -->
            <div id="contacts-tab" class="tab-content hidden h-full flex flex-col">
                <h2 class="text-xl font-bold mb-4 text-whatsapp-green">Daftar Kontak</h2>
                <div id="contact-list" class="flex flex-col space-y-2 mb-4">
                    <!-- Contacts will be listed here -->
                </div>

                <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold mb-3">Tambah Kontak Baru</h3>
                    <input type="text" id="new-contact-id" placeholder="ID Pengguna (User ID) Kontak" class="w-full p-2 mb-2 rounded border border-gray-300 focus:ring-whatsapp-green focus:border-whatsapp-green">
                    <button id="add-contact-button" class="w-full bg-whatsapp-green text-white py-2 rounded-lg font-semibold hover:bg-whatsapp-light-green transition duration-150">
                        <i class="fas fa-user-plus mr-2"></i> Tambah
                    </button>
                </div>
            </div>
            
            <!-- STATUS, CALLS, COMMUNITY (Placeholder Content) -->
            <div id="status-tab" class="tab-content hidden text-center p-10">
                <i class="fas fa-circle-notch text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600">Fitur Status belum diimplementasikan.</p>
            </div>
            <div id="calls-tab" class="tab-content hidden text-center p-10">
                <i class="fas fa-phone-alt text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600">Fitur Panggilan belum diimplementasikan.</p>
            </div>
            
        </main>
    </div>

    <!-- JAVASCRIPT START -->
    <script type="module">
        // --- Firebase Imports ---
        // Menggunakan CDN versi 12.4.0 untuk konsistensi dengan konfigurasi Anda
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, addDoc, serverTimestamp, updateDoc, doc, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // --- Firebase Configuration (Disediakan oleh Pengguna) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD9tO94PdmXnqSH4cMVLPbgcEyY1J266mQ",
            authDomain: "whatsapp-clone-web-9418e.firebaseapp.com",
            projectId: "whatsapp-clone-web-9418e",
            storageBucket: "whatsapp-clone-web-9418e.firebasestorage.app",
            messagingSenderId: "31927689655",
            appId: "1:31927689655:web:3e4da24d4237a7ffb08832",
            measurementId: "G-5624HP8XEX"
        };
        
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- Global State ---
        let currentUserId = null;
        let currentChatContact = null; // null untuk Public Chat, string (ID) untuk Private Chat
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // Wajib sesuai pedoman
        
        // --- DOM Elements ---
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const appTitle = document.getElementById('app-title');
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const contactList = document.getElementById('contact-list');
        const newContactIdInput = document.getElementById('new-contact-id');
        const addContactButton = document.getElementById('add-contact-button');

        // --- Utility Functions ---

        /**
         * Mengkonversi timestamp Firestore menjadi string waktu lokal (HH:MM).
         * @param {Object} timestamp - Objek Firestore Timestamp.
         * @returns {string} Waktu yang diformat.
         */
        const formatTime = (timestamp) => {
            if (!timestamp) return '...';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        };

        /**
         * Merender pesan di kontainer chat.
         * @param {Array<Object>} messages - Daftar objek pesan.
         */
        const renderMessages = (messages) => {
            messagesContainer.innerHTML = ''; // Kosongkan kontainer
            if (messages.length === 0) {
                messagesContainer.innerHTML = `<div class="text-center text-gray-500 p-4">Tidak ada pesan. Mulailah chat!</div>`;
                return;
            }

            messages.forEach(msg => {
                const isSentByMe = msg.senderId === currentUserId;
                const alignmentClass = isSentByMe ? 'sent' : 'received';
                const displayName = isSentByMe ? 'Anda' : (msg.senderName || msg.senderId.substring(0, 8)); // Tampilkan 8 digit ID
                const nameColor = isSentByMe ? 'text-gray-700' : 'text-blue-600';

                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-bubble ${alignmentClass} shadow-md flex flex-col`;

                // Tampilkan nama pengirim jika bukan pesan saya
                if (!isSentByMe || currentChatContact) {
                    const nameSpan = document.createElement('span');
                    nameSpan.className = `text-xs font-semibold mb-1 ${nameColor}`;
                    nameSpan.textContent = displayName;
                    messageDiv.appendChild(nameSpan);
                }

                // Konten pesan
                const contentSpan = document.createElement('span');
                contentSpan.className = 'text-sm text-black';
                contentSpan.textContent = msg.text;
                messageDiv.appendChild(contentSpan);

                // Waktu pesan
                const timeSpan = document.createElement('span');
                timeSpan.className = 'text-xs text-gray-500 self-end mt-1 ml-4';
                timeSpan.textContent = formatTime(msg.timestamp);
                messageDiv.appendChild(timeSpan);
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // Scroll ke bawah
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        /**
         * Mengirim pesan ke koleksi yang sesuai (Public atau Private).
         * @param {string} text - Teks pesan.
         */
        const sendMessage = async (text) => {
            if (!text.trim() || !currentUserId) return;
            
            let messageRef;
            
            try {
                const messageData = {
                    text: text.trim(),
                    timestamp: serverTimestamp(),
                    senderId: currentUserId,
                    senderName: currentUserId.substring(0, 8), // Nama singkat
                    type: 'text'
                };
                
                if (currentChatContact) {
                    // PRIVATE CHAT
                    // Koleksi diurutkan agar konsisten (misalnya: A_B atau B_A)
                    const chatRoomId = [currentUserId, currentChatContact].sort().join('_');
                    const privateChatPath = `/artifacts/${appId}/private/chats/${chatRoomId}/messages`;
                    messageRef = collection(db, privateChatPath);

                } else {
                    // PUBLIC CHAT
                    const publicChatPath = `/artifacts/${appId}/public/data/global_chat`;
                    messageRef = collection(db, publicChatPath);
                }

                await addDoc(messageRef, messageData);
                messageInput.value = ''; // Kosongkan input
            } catch (error) {
                console.error("Gagal mengirim pesan: ", error);
            }
        };
        
        /**
         * Menyiapkan listener real-time untuk pesan (Public atau Private).
         */
        const listenForMessages = () => {
            let messagesQuery;
            let collectionPath;
            
            if (currentChatContact) {
                // PRIVATE CHAT QUERY
                const chatRoomId = [currentUserId, currentChatContact].sort().join('_');
                collectionPath = `/artifacts/${appId}/private/chats/${chatRoomId}/messages`;
            } else {
                // PUBLIC CHAT QUERY
                collectionPath = `/artifacts/${appId}/public/data/global_chat`;
            }
            
            // Mengambil 50 pesan terakhir (tidak menggunakan orderBy untuk menghindari masalah index, diurutkan di client)
            messagesQuery = collection(db, collectionPath); 

            // Hapus listener lama jika ada (tidak diperlukan secara eksplisit di sini, karena onSnapshot mengembalikan fungsi unsubscribe)
            // Namun, di aplikasi yang lebih besar, fungsi unsubscribe harus digunakan.

            // Mulai listener baru
            return onSnapshot(messagesQuery, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                // Urutkan di client side berdasarkan timestamp karena menghindari orderBy di query
                messages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
                
                renderMessages(messages);
            }, (error) => {
                console.error("Gagal mendengarkan pesan:", error);
                messagesContainer.innerHTML = `<div class="text-center text-red-500 p-4">Gagal memuat pesan. Cek konsol.</div>`;
            });
        };
        
        /**
         * Memuat dan menampilkan daftar kontak pengguna.
         */
        const loadContacts = async () => {
            contactList.innerHTML = '';
            if (!currentUserId) return;
            
            try {
                const contactsPath = `/artifacts/${appId}/users/${currentUserId}/contacts`;
                const q = collection(db, contactsPath);
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    contactList.innerHTML = `<p class="text-gray-500 italic p-2">Belum ada kontak. Tambahkan ID teman Anda di bawah.</p>`;
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const contactData = doc.data();
                    const contactId = doc.id;
                    
                    const contactItem = document.createElement('div');
                    contactItem.className = 'contact-item flex items-center p-3 rounded-lg bg-white shadow-sm';
                    contactItem.setAttribute('data-contact-id', contactId);
                    
                    contactItem.innerHTML = `
                        <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3 text-lg text-whatsapp-green">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800">Kontak: ${contactData.name || contactId.substring(0, 8)}</p>
                            <p class="text-xs text-gray-500 truncate">ID: ${contactId}</p>
                        </div>
                    `;
                    
                    contactItem.addEventListener('click', () => startPrivateChat(contactId, contactData.name));
                    contactList.appendChild(contactItem);
                });
                
            } catch (error) {
                console.error("Gagal memuat kontak:", error);
                contactList.innerHTML = `<p class="text-red-500 p-2">Error memuat kontak.</p>`;
            }
        };

        /**
         * Memulai sesi chat privat dengan kontak.
         * @param {string} contactId - ID pengguna kontak.
         * @param {string} contactName - Nama kontak.
         */
        const startPrivateChat = (contactId, contactName) => {
            currentChatContact = contactId;
            appTitle.textContent = `Chat dengan ${contactName || contactId.substring(0, 8)}`;
            
            // Pindah ke tab chat
            document.querySelector('.tab-link[data-tab="chat"]').click(); 
            
            // Mulai listener untuk chat privat
            listenForMessages();
        };

        /**
         * Menambahkan ID pengguna ke daftar kontak.
         */
        const addContact = async () => {
            const newContactId = newContactIdInput.value.trim();
            if (!newContactId || !currentUserId) return;

            if (newContactId === currentUserId) {
                alert('Tidak bisa menambahkan diri sendiri sebagai kontak!');
                return;
            }

            try {
                const contactDocPath = `/artifacts/${appId}/users/${currentUserId}/contacts/${newContactId}`;
                await updateDoc(doc(db, contactDocPath), { 
                    name: newContactId.substring(0, 8), // Default name
                    addedAt: serverTimestamp() 
                }, { merge: true });

                newContactIdInput.value = '';
                await loadContacts(); // Refresh daftar kontak
                alert('Kontak berhasil ditambahkan!');
            } catch (error) {
                console.error("Gagal menambahkan kontak: ", error);
                alert('Gagal menambahkan kontak. Pastikan ID benar.');
            }
        };
        
        // --- Initialization and Event Handlers ---
        
        /**
         * Menginisialisasi otentikasi dan menyiapkan listener.
         */
        const initializeAppAndListeners = () => {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplay.textContent = `ID Anda: ${currentUserId}`;
                    
                    // Set up initial listeners
                    listenForMessages(); // Mulai Public Chat secara default
                    loadContacts();
                } else {
                    // Coba sign in secara anonim jika belum ada user
                    signInAnonymously(auth)
                        .catch((error) => {
                            console.error("Gagal sign in anonim:", error);
                            userIdDisplay.textContent = "Gagal terhubung ke server.";
                        });
                }
            });
            
            // Event listener untuk tombol kirim
            sendButton.addEventListener('click', () => sendMessage(messageInput.value));
            
            // Event listener untuk tombol Enter di input
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage(messageInput.value);
                }
            });
            
            // Event listener untuk tombol tambah kontak
            addContactButton.addEventListener('click', addContact);

            // Tab navigation handler
            tabLinks.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // 1. Update active tab styling
                    tabLinks.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // 2. Update active content
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                        content.classList.remove('active');
                        if (content.id === `${tabId}-tab`) {
                            content.classList.remove('hidden');
                            content.classList.add('active');
                        }
                    });
                    
                    // 3. LOGIKA UNTUK CHAT: Reset ke public chat/load kontak
                    if (tabId === 'chat') {
                        // Reset state chat ke Public/Group Chat jika tidak ada chat privat yang sedang aktif
                        if (currentChatContact) {
                            // Jika ada chat privat aktif, biarkan
                        } else {
                            appTitle.textContent = 'WhatsApp';
                            listenForMessages(); 
                        }
                    } else if (tabId === 'contacts') {
                        loadContacts();
                        // Reset judul kembali ke default agar tidak menampilkan nama kontak
                        appTitle.textContent = 'WhatsApp';
                        currentChatContact = null; // Pastikan chat direset saat pindah ke kontak
                    } else {
                        appTitle.textContent = 'WhatsApp';
                        currentChatContact = null; // Pastikan chat direset saat pindah ke tab lain
                    }
                });
            });
        };

        // Mulai aplikasi
        initializeAppAndListeners();
        
    </script>
    <!-- JAVASCRIPT END -->
</body>
</html>
