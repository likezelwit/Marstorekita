<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KawanChat ‚Äî Deluxe</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root{
      --kc-green: #25D366;
      --kc-dark: #075E32;
      --kc-light: #dcf8c6;
      --kc-bg: #f0f4f2;
    }
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--kc-bg); margin:0; display:flex; align-items:center; justify-content:center; min-height:100vh;}
    .app{width:100%;max-width:540px;height:100vh;background:white;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,.12);overflow:hidden;display:flex;flex-direction:column;position:relative;}
    header.app-header{background:var(--kc-dark);color:white;padding:14px;display:flex;justify-content:space-between;align-items:center;}
    .tabs{display:flex;background:var(--kc-green);color:#053618}
    .tabs button{flex:1;padding:12px;border:none;background:transparent;color:rgba(0,0,0,.6);font-weight:600}
    .tabs button.active{background:rgba(255,255,255,.08);color:white;border-bottom:3px solid rgba(255,255,255,.9)}
    /* stages */
    .stage{display:none;flex-direction:column;align-items:center;justify-content:center;padding:24px;height:100%}
    .stage.active{display:flex}
    .card{background:white;border-radius:12px;padding:20px;box-shadow:0 8px 24px rgba(5,94,50,.08);max-width:460px;width:90%}
    .typing{min-height:48px}
    .flex-grow-scroll{flex:1;display:flex;flex-direction:column;min-height:0}
    .scroll{overflow:auto}
    .chat-bubble{max-width:78%;padding:10px 14px;border-radius:16px;margin-bottom:8px;word-wrap:break-word}
    .sent{background:var(--kc-light);align-self:flex-end;border-bottom-right-radius:4px}
    .recv{background:white;border:1px solid #eee;align-self:flex-start;border-bottom-left-radius:4px}
    #fab-add{position:absolute;right:18px;bottom:18px;z-index:40;display:none}
    .notif{position:fixed;right:20px;bottom:20px;background:#16a34a;color:white;padding:10px 14px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.18);z-index:60}
    .muted{color:#6b7280}
    .input-pill{border-radius:999px;padding:10px 14px;border:1px solid #e5e7eb}
    .btn-green{background:var(--kc-dark);color:white;padding:8px 12px;border-radius:10px}
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- LOADING -->
    <div id="loading-stage" class="stage active">
      <div class="card text-center">
        <div class="mb-4"><i class="fas fa-spinner fa-spin text-3xl" style="color:var(--kc-dark)"></i></div>
        <div class="text-gray-600">Memuat KawanChat...</div>
      </div>
    </div>

    <!-- WELCOME (full-screen + card chat style) -->
    <div id="welcome-stage" class="stage">
      <div class="card text-center">
        <h2 class="text-2xl font-bold text-kc" style="color:var(--kc-dark)">üëã Selamat datang di KawanChat</h2>
        <div id="sapaan-content" class="typing text-lg text-gray-700 mt-4 mb-4"> </div>
        <div id="tos" class="hidden text-left bg-gray-50 p-3 rounded mb-3">
          <label class="flex items-center space-x-2">
            <input id="agree-tos" type="checkbox" />
            <span class="text-sm muted">Saya setuju Persyaratan & Ketentuan KawanChat.</span>
          </label>
        </div>
        <div class="mt-3">
          <button id="welcome-next" class="btn-green" disabled>Lanjut</button>
        </div>
      </div>
    </div>

    <!-- REGISTRATION -->
    <div id="registration-stage" class="stage">
      <div class="card">
        <div id="reg-typing" class="typing text-xl font-bold text-gray-800 mb-4"></div>

        <div id="name-area" class="hidden space-y-3">
          <input id="reg-first" placeholder="Nama Depan" class="input-pill w-full" />
          <div id="name-feedback" class="text-sm muted min-h-[20px]"> </div>
          <input id="reg-last" placeholder="Nama Belakang (Opsional)" class="input-pill w-full" />
          <select id="reg-gender" class="input-pill w-full">
            <option value="">Pilih Jenis Kelamin</option>
            <option value="L">Laki-laki</option>
            <option value="P">Perempuan</option>
            <option value="O">Lainnya</option>
          </select>
        </div>

        <div id="phone-area" class="hidden space-y-3">
          <div class="flex items-center">
            <div id="phone-emoji" class="text-2xl mr-3">üôç‚Äç‚ôÇÔ∏è</div>
            <div class="flex-1">
              <div class="flex border rounded overflow-hidden">
                <div class="px-3 flex items-center bg-white">+62</div>
                <input id="reg-phone" placeholder="812345678" class="flex-1 p-3 border-none outline-none" />
              </div>
              <div class="text-sm muted mt-1">Contoh: 812345678 (tanpa 0 di depan)</div>
            </div>
          </div>
        </div>

        <div id="final-area" class="hidden text-center text-green-700 font-semibold min-h-[44px]"></div>

        <div class="mt-4 text-center">
          <button id="reg-next" class="btn-green">Selanjutnya</button>
        </div>
      </div>
    </div>

    <!-- MAIN APP -->
    <header class="app-header" id="app-header" style="display:none">
      <div>
        <div class="text-sm muted">KawanChat</div>
        <div id="display-name" class="text-xs"></div>
      </div>
      <div class="text-sm muted">ID: <span id="display-id" class="font-mono"></span></div>
    </header>

    <div id="main-app" class="hidden flex flex-col h-full">
      <nav class="tabs">
        <button class="active" data-tab="chat-tab">OBROLAN</button>
        <button data-tab="status-tab">STATUS</button>
        <button data-tab="calls-tab">PANGGILAN</button>
        <button data-tab="contacts-tab">KONTAK</button>
      </nav>

      <main class="flex-grow-scroll">
        <!-- CHAT TAB -->
        <section id="chat-tab" class="tab-content flex flex-col flex-1 p-3">
          <div class="flex-1 flex overflow-hidden">
            <div id="active-chats" class="w-1/3 bg-white rounded p-2 mr-3 scroll h-full"></div>
            <div class="flex-1 bg-[#f7fff5] p-3 rounded flex flex-col">
              <div id="chat-header" class="flex items-center justify-between mb-3">
                <div id="chat-with" class="font-semibold text-lg muted">Pilih kontak untuk mulai chat</div>
                <div id="chat-actions" class="text-sm muted"></div>
              </div>
              <div id="messages" class="flex-1 scroll p-2 flex flex-col"></div>
              <div id="message-area" class="mt-3 hidden items-center">
                <input id="message-input" class="flex-1 p-3 rounded-full border bg-white outline-none" placeholder="Ketik pesan..." />
                <button id="send-btn" class="ml-2 px-4 py-2 rounded-full text-white" style="background:var(--kc-dark)"><i class="fas fa-paper-plane"></i></button>
              </div>
            </div>
          </div>
        </section>

        <!-- STATUS -->
        <section id="status-tab" class="tab-content hidden p-6 text-center">
          <i class="fas fa-circle-notch text-4xl muted mb-4"></i>
          <div class="muted">Fitur Status belum diimplementasikan.</div>
        </section>

        <!-- CALLS -->
        <section id="calls-tab" class="tab-content hidden p-6 text-center">
          <i class="fas fa-phone-alt text-4xl muted mb-4"></i>
          <div class="muted">Fitur Panggilan belum diimplementasikan.</div>
        </section>

        <!-- CONTACTS -->
        <section id="contacts-tab" class="tab-content hidden p-4">
          <div class="flex items-center mb-3">
            <input id="search-contact" placeholder="Cari kontak..." class="input-pill flex-1 mr-2" />
            <button id="btn-search" class="btn-green">Cari</button>
          </div>
          <div class="flex mb-3">
            <input id="new-contact-input" placeholder="Masukkan ID pengguna (UID/8 char)" class="flex-1 p-2 border rounded-l" />
            <button id="add-contact-btn" class="bg-[#0b8a3a] text-white px-4 rounded-r">Tambah</button>
          </div>
          <h4 class="font-semibold mb-2 muted">Daftar Kontak</h4>
          <div id="contacts-list" class="contacts-list scroll h-72 p-2 bg-white rounded"></div>
        </section>
      </main>

      <button id="fab-add" title="Tambah kontak" style="display:none" class="btn-green" >
        <i class="fas fa-user-plus"></i>
      </button>
    </div>
  </div>

  <!-- SCRIPT: Firebase + App Logic -->
  <script type="module">
    // Firebase v12 imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, addDoc, serverTimestamp, onSnapshot, query, orderBy, where, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // --- Firebase config (user provided) ---
    const firebaseConfig = {
      apiKey: "AIzaSyD9tO94PdmXnqSH4cMVLPbgcEyY1J266mQ",
      authDomain: "whatsapp-clone-web-9418e.firebaseapp.com",
      projectId: "whatsapp-clone-web-9418e",
      storageBucket: "whatsapp-clone-web-9418e.firebasestorage.app",
      messagingSenderId: "31927689655",
      appId: "1:31927689655:web:3e4da24d4237a7ffb08832",
      measurementId: "G-5624HP8XEX"
    };

    // init firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // app state
    const appId = 'kawanchat-v1';
    let currentUserId = null;
    let currentUserName = null;
    let currentChatContact = null;
    let unsubscribeMessages = null;
    let contactsUnsub = null;

    // DOM refs
    const loadingStage = document.getElementById('loading-stage');
    const welcomeStage = document.getElementById('welcome-stage');
    const registrationStage = document.getElementById('registration-stage');
    const mainApp = document.getElementById('main-app');
    const appHeader = document.getElementById('app-header');

    const sapaanContent = document.getElementById('sapaan-content');
    const welcomeNext = document.getElementById('welcome-next');
    const tosBox = document.getElementById('tos');
    const agreeTos = document.getElementById('agree-tos');

    const regTyping = document.getElementById('reg-typing');
    const nameArea = document.getElementById('name-area');
    const regFirst = document.getElementById('reg-first');
    const regLast = document.getElementById('reg-last');
    const regGender = document.getElementById('reg-gender');
    const nameFeedback = document.getElementById('name-feedback');

    const phoneArea = document.getElementById('phone-area');
    const regPhone = document.getElementById('reg-phone');
    const phoneEmoji = document.getElementById('phone-emoji');

    const finalArea = document.getElementById('final-area');
    const regNext = document.getElementById('reg-next');

    const displayNameEl = document.getElementById('display-name');
    const displayIdEl = document.getElementById('display-id');

    const tabs = document.querySelectorAll('.tabs button');
    const tabContents = document.querySelectorAll('.tab-content');
    const fabAdd = document.getElementById('fab-add');

    const activeChats = document.getElementById('active-chats');
    const messagesEl = document.getElementById('messages');
    const chatWithEl = document.getElementById('chat-with');
    const messageArea = document.getElementById('message-area');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    const contactsList = document.getElementById('contacts-list');
    const newContactInput = document.getElementById('new-contact-input');
    const addContactBtn = document.getElementById('add-contact-btn');
    const searchContactInput = document.getElementById('search-contact');
    const btnSearch = document.getElementById('btn-search');

    // onboarding texts
    const sapaanTexts = [
      "Selamat datang di KawanChat! üëã",
      "Di KawanChat kamu bisa chat dengan teman lama maupun teman baru. Serasa gampang antar negara! üåê",
      "KawanChat adalah tempat yang aman untuk berbagi cerita. üîí",
      "Persahabatan sejati dimulai dari pesan sederhana. Mari kita mulai! üí¨"
    ];
    let sapaanStep = 0;

    // utilities
    const setStage = (id) => {
      [loadingStage, welcomeStage, registrationStage, mainApp].forEach(s => s.classList.remove('active'));
      [loadingStage, welcomeStage, registrationStage, mainApp].forEach(s => s.classList.add('hidden'));
      const target = document.getElementById(id);
      if (target) target.classList.remove('hidden'), target.classList.add('active');
      // header visibility
      if (id === 'main-app') appHeader.style.display = 'flex'; else appHeader.style.display = 'none';
    };

    const typeText = (el, text, speed = 24) => {
      return new Promise(res => {
        el.textContent = '';
        let i = 0;
        const t = setInterval(() => {
          if (i < text.length) { el.textContent += text.charAt(i); i++; } else { clearInterval(t); res(); }
        }, speed);
      });
    };

    const showNotif = (txt) => {
      const n = document.createElement('div'); n.className='notif'; n.textContent = txt;
      document.body.appendChild(n);
      setTimeout(()=> n.remove(), 3000);
    };

    // Onboarding flow
    const nextSapaan = async () => {
      welcomeNext.disabled = true;
      if (sapaanStep < sapaanTexts.length) {
        await typeText(sapaanContent, sapaanTexts[sapaanStep]);
        sapaanStep++;
        welcomeNext.disabled = false;
      } else if (sapaanStep === sapaanTexts.length) {
        await typeText(sapaanContent, "Satu langkah lagi! Silakan setujui persyaratan kami untuk melanjutkan:");
        tosBox.classList.remove('hidden');
        welcomeNext.disabled = !agreeTos.checked;
        sapaanStep++;
      } else {
        setStage('registration-stage');
        startRegistration();
      }
    };
    agreeTos.addEventListener('change', () => welcomeNext.disabled = !agreeTos.checked);
    welcomeNext.addEventListener('click', nextSapaan);

    // Registration steps
    let currentUserName = null;
    const startRegistration = async () => {
      regNext.disabled = true;
      await regStep1();
    };

    const regStep1 = async () => {
      nameArea.classList.add('hidden'); phoneArea.classList.add('hidden'); finalArea.classList.add('hidden');
      await typeText(regTyping, "Kita belum kenalan nih! Kenalan dulu yuk! üôã");
      nameArea.classList.remove('hidden');
      regFirst.focus();
      const nameHandler = () => {
        if (regFirst.value.trim().length > 0) { nameFeedback.textContent = "Hmm kalo nama belakang boleh tau? (opsional)"; regNext.disabled = false; } else { nameFeedback.textContent=''; regNext.disabled = true; }
      };
      regFirst.addEventListener('input', nameHandler);
      regNext.onclick = () => {
        regFirst.removeEventListener('input', nameHandler);
        if (regFirst.value.trim()) regStep2();
      };
    };

    const regStep2 = async () => {
      nameArea.classList.add('hidden');
      currentUserName = (regFirst.value.trim() + (regLast.value.trim() ? ' '+regLast.value.trim() : '')).trim();
      await typeText(regTyping, `Yey kita udh kenalan! Hi ${regFirst.value.trim()} üôå`);
      await new Promise(r=>setTimeout(r,700));
      await typeText(regTyping, "Hmm boleh minta nomor mu untuk masuk ke dalam KawanChat? üìû");
      phoneArea.classList.remove('hidden');
      regPhone.focus();

      const focusFn = () => phoneEmoji.textContent = 'ü§¶‚Äç‚ôÇÔ∏è';
      const blurFn = () => phoneEmoji.textContent = 'üôç‚Äç‚ôÇÔ∏è';
      regPhone.addEventListener('focus', focusFn);
      regPhone.addEventListener('blur', blurFn);

      const phoneHandler = () => regNext.disabled = regPhone.value.replace(/\D/g,'').length < 8;
      regPhone.addEventListener('input', phoneHandler);

      regNext.onclick = () => {
        regPhone.removeEventListener('input', phoneHandler);
        regPhone.removeEventListener('focus', focusFn);
        regPhone.removeEventListener('blur', blurFn);
        if (regPhone.value.replace(/\D/g,'').length >= 8) regStep3();
      };
    };

    const signInAndSave = async (displayName, chatID, phoneVal) => {
      const user = auth.currentUser;
      if (!user) throw new Error('User not authenticated');
      await updateProfile(user, { displayName });
      const userDoc = doc(db, `artifacts/${appId}/users/${user.uid}`);
      await setDoc(userDoc, {
        name: displayName,
        id: chatID,
        phone: phoneVal,
        gender: regGender.value || '',
        createdAt: serverTimestamp()
      }, { merge: true });
      currentUserId = user.uid;
      currentUserName = displayName;
    };

    const regStep3 = async () => {
      phoneArea.classList.add('hidden');
      regNext.classList.add('hidden');

      const phoneRaw = regPhone.value.replace(/[^0-9]/g,'');
      const full = '62' + phoneRaw.replace(/^0+/, '');
      await typeText(regTyping, `Nomormu cantik banget ‚ú® kita ambil dari depan nomor mu yah!`);
      await new Promise(r=>setTimeout(r,700));

      const mockID = full.padEnd(11,'0');
      const prefix = mockID.substring(0,5);
      await typeText(regTyping, `Oke nomor depan mu ${prefix} kita tambahin jadi ${mockID}!`);
      await new Promise(r=>setTimeout(r,800));

      const finalID = mockID.substring(mockID.length - 6);
      await typeText(regTyping, `Yey! ID mu udh di buat! Ini dia: ${finalID} üéâ`);
      await new Promise(r=>setTimeout(r,800));

      try {
        await signInAndSave(currentUserName || regFirst.value.trim(), finalID, regPhone.value);
      } catch(err){ console.error('save profile err', err); }

      await typeText(regTyping, `Selamat datang di KawanChat, ${(currentUserName||regFirst.value.trim()).split(' ')[0]}!`);
      await new Promise(r=>setTimeout(r,800));

      setStage('main-app');
      initMainApp();
    };

    // Auth init
    const initializeAuth = async () => {
      try { await signInAnonymously(auth); } catch(err){ console.error('signInAnon err', err); setStage('welcome-stage'); sapaanContent.textContent = "Error: Gagal terhubung ke server Firebase."; welcomeNext.disabled = true; }
    };

    onAuthStateChanged(auth, async (user) => {
      if (!user) { await initializeAuth(); return; }
      // check if profile doc exists
      const userDocRef = doc(db, `artifacts/${appId}/users/${user.uid}`);
      const snap = await getDoc(userDocRef);
      if (snap.exists()) {
        currentUserId = user.uid;
        currentUserName = user.displayName || snap.data().name;
        displayNameEl.textContent = currentUserName || 'Teman';
        displayIdEl.textContent = currentUserId.substring(0,8);
        setStage('main-app');
        initMainApp();
      } else {
        setStage('welcome-stage');
        sapaanStep = 0;
        nextSapaan();
      }
    });

    // MAIN APP
    const initMainApp = () => {
      displayNameEl.textContent = currentUserName || 'Teman';
      displayIdEl.textContent = currentUserId ? currentUserId.substring(0,8) : '';
      bindTabs();
      fabAdd.style.display = 'block';
      document.getElementById('fab-add').style.display = 'block';
      loadContactsRealtime();
      loadActiveChats();
    };

    function bindTabs(){
      tabs.forEach(btn => {
        btn.onclick = () => {
          tabs.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          tabContents.forEach(tc => tc.classList.add('hidden'));
          const id = btn.getAttribute('data-tab');
          document.getElementById(id).classList.remove('hidden');
          // toggle FAB / message area
          if (id === 'chat-tab') { fabAdd.style.display = 'block'; } else { fabAdd.style.display = 'none'; }
        };
      });
    }

    // Contacts realtime + render
    const loadContactsRealtime = async () => {
      if (!currentUserId) return;
      const cRef = collection(db, `artifacts/${appId}/users/${currentUserId}/contacts`);
      if (contactsUnsub) contactsUnsub();
      contactsUnsub = onSnapshot(cRef, (snap) => {
        contactsList.innerHTML = '';
        activeChats.innerHTML = '';
        if (snap.empty) {
          contactsList.innerHTML = '<div class="muted p-2">Belum ada kontak.</div>';
          activeChats.innerHTML = '<div class="muted p-2">Klik tombol + untuk tambah kontak.</div>';
          return;
        }
        snap.forEach(d => {
          const id = d.id; const data = d.data();
          // contacts list (tab)
          const row = document.createElement('div'); row.className='p-2 border-b flex items-center justify-between';
          row.innerHTML = `<div><div class="font-semibold">${data.name||id.substring(0,8)}</div><div class="text-xs muted">ID: ${id}</div></div>`;
          const chatBtn = document.createElement('button'); chatBtn.className='btn-green text-sm'; chatBtn.textContent = 'Chat';
          chatBtn.onclick = () => { startPrivateChat(id, data.name||id.substring(0,8)); };
          row.appendChild(chatBtn);
          contactsList.appendChild(row);

          // active chats left column
          const ac = document.createElement('div'); ac.className='p-2 mb-2 bg-white rounded cursor-pointer';
          ac.textContent = `${data.name||id.substring(0,8)} ‚Äî ID:${id}`;
          ac.onclick = () => startPrivateChat(id, data.name||id.substring(0,8));
          activeChats.appendChild(ac);
        });
      }, (e)=> console.error('contacts snapshot err', e));
    };

    // optional active chats loader (placeholder)
    const loadActiveChats = () => {
      // left column populated by contacts snapshot
    };

    // Start private chat & messages listener
    const startPrivateChat = (contactId, contactName) => {
      currentChatContact = contactId;
      chatWithEl.textContent = contactName;
      messagesEl.innerHTML = '';
      messageArea.classList.remove('hidden');
      messageInput.value = '';
      // unsubscribe previous
      if (unsubscribeMessages) unsubscribeMessages();
      // message path: artifacts/<appId>/private/chats/<sorted>/messages
      const chatRoomId = [currentUserId, contactId].sort().join('_');
      const messagesRef = collection(db, `artifacts/${appId}/private/chats/${chatRoomId}/messages`);
      const q = query(messagesRef, orderBy('timestamp','asc'));
      unsubscribeMessages = onSnapshot(q, (snap) => {
        const msgs = []; snap.forEach(d => msgs.push({ id: d.id, ...d.data() }));
        renderMessages(msgs);
      }, (e) => console.error('messages snapshot err', e));
      // switch to chat tab UI
      document.querySelector('.tabs button[data-tab="chat-tab"]').click();
      // scroll left column to selected - optional
    };

    const renderMessages = (messages) => {
      messagesEl.innerHTML = '';
      if (!messages.length) {
        messagesEl.innerHTML = `<div class="muted text-center p-4">Awal dari obrolan dengan ${chatWithEl.textContent}.</div>`;
        messagesEl.scrollTop = messagesEl.scrollHeight;
        return;
      }
      messages.forEach(m => {
        const el = document.createElement('div');
        el.className = 'chat-bubble ' + (m.senderId === currentUserId ? 'sent' : 'recv');
        el.style.alignSelf = (m.senderId === currentUserId) ? 'flex-end' : 'flex-start';
        const name = m.senderId === currentUserId ? (currentUserName || 'Kamu') : (m.senderName || chatWithEl.textContent);
        const time = m.timestamp ? new Date(m.timestamp.toDate ? m.timestamp.toDate() : m.timestamp).toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' }) : '...';
        el.innerHTML = `<div class="text-xs font-semibold ${m.senderId===currentUserId?'text-gray-700':'text-green-700'} mb-1">${name}</div>
                        <div class="text-sm">${m.text}</div>
                        <div class="text-xs muted mt-1" style="text-align:right">${time}</div>`;
        messagesEl.appendChild(el);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    };

    // send message (ensure room exists)
    const sendMessage = async (txt) => {
      if (!txt.trim() || !currentChatContact || !currentUserId) return;
      try {
        const chatRoomId = [currentUserId, currentChatContact].sort().join('_');
        const messagesRef = collection(db, `artifacts/${appId}/private/chats/${chatRoomId}/messages`);
        await addDoc(messagesRef, {
          text: txt.trim(),
          timestamp: serverTimestamp(),
          senderId: currentUserId,
          senderName: currentUserName || '',
          type: 'text'
        });
        messageInput.value = '';
      } catch (err) {
        console.error('sendMessage err', err);
        showNotif('Gagal mengirim pesan');
      }
    };

    // add contact (two-way) with existence check
    addContactBtn.addEventListener('click', async () => {
      const newId = newContactInput.value.trim();
      if (!newId) return alert('Masukkan ID kontak.');
      if (!currentUserId) return alert('Belum login.');
      if (newId === currentUserId) return alert('Tidak bisa menambahkan diri sendiri.');
      try {
        // basic check: does user document exist for that ID? (we assume they must have UID)
        const otherUserDoc = doc(db, `artifacts/${appId}/users/${newId}`);
        const snapshot = await getDoc(otherUserDoc);
        if (!snapshot.exists()) {
          // allow adding anyway but warn
          if (!confirm('Pengguna dengan ID ini belum terdaftar. Tetap tambah sebagai kontak?')) return;
        }
        const path1 = doc(db, `artifacts/${appId}/users/${currentUserId}/contacts/${newId}`);
        const path2 = doc(db, `artifacts/${appId}/users/${newId}/contacts/${currentUserId}`);
        await setDoc(path1, { name: newId.substring(0,8), addedAt: serverTimestamp() }, { merge: true });
        // attempt to write reverse (if user exists)
        await setDoc(path2, { name: currentUserId.substring(0,8), addedAt: serverTimestamp() }, { merge: true });
        showNotif(`Kontak ${newId} berhasil ditambahkan!`);
        newContactInput.value = '';
      } catch (err) {
        console.error('addContact err', err);
        alert('Gagal menambahkan kontak. Cek console.');
      }
    });

    // search contact (filter client-side by displayed contacts)
    btnSearch.addEventListener('click', () => {
      const q = searchContactInput.value.trim().toLowerCase();
      const children = Array.from(contactsList.children);
      if (!q) { children.forEach(c => c.style.display='flex'); return; }
      children.forEach(c => {
        const text = c.textContent.toLowerCase();
        c.style.display = text.includes(q) ? 'flex' : 'none';
      });
    });
    searchContactInput.addEventListener('keypress', (e) => { if (e.key==='Enter') btnSearch.click(); });

    // FAB -> go to contacts tab
    fabAdd.addEventListener('click', () => {
      document.querySelector('.tabs button[data-tab="contacts-tab"]').click();
      newContactInput.focus();
    });

    // send & enter
    sendBtn.addEventListener('click', () => sendMessage(messageInput.value));
    messageInput.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(messageInput.value); });

    // init on load
    window.addEventListener('load', () => {
      setTimeout(() => { setStage('loading-stage'); initializeAuth(); }, 300);
    });

  </script>
</body>
</html>
