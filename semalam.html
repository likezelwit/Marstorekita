<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KawanChat - Real-time Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for KawanChat look and feel */
        :root {
            --kawanchat-blue: #0A5FAD; /* Warna Dominan */
            --kawanchat-light-blue: #1C8EED;
            --kawanchat-bubble-sent: #D1E7F9; /* Lebih soft dari WA */
            --kawanchat-bg: #F0F2F5; /* Background aplikasi */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--kawanchat-bg);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .app-container {
            height: 100vh;
            max-width: 500px;
            width: 100%;
            margin: 0 auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            background-color: white;
        }
        /* Header */
        .header {
            background-color: var(--kawanchat-blue);
        }
        .tab-bar {
            background-color: var(--kawanchat-light-blue);
        }
        .tab-bar button.active {
            border-bottom: 3px solid white;
            color: white;
            font-weight: 600;
        }

        /* Message Bubbles */
        .chat-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            word-wrap: break-word;
        }
        .sent {
            background-color: var(--kawanchat-bubble-sent);
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .received {
            background-color: #ffffff; /* Putih bersih untuk diterima */
            border: 1px solid #ddd;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        /* Stages (Welcome/Registration) */
        .stage {
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 20px;
            height: 100%;
        }
        .stage.active {
            display: flex;
        }
        
        /* Typing Animation effect */
        .typing-text-container {
            min-height: 30px; /* Menghindari layout jump */
        }
        
        /* Float button for new chat */
        #new-chat-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 10;
        }

        /* Hide message input initially */
        #chat-message-area {
            display: none;
        }
        #message-input:focus {
             outline: none;
             box-shadow: 0 0 0 2px var(--kawanchat-light-blue);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="app-container bg-white">
        <div id="loading-stage" class="stage active flex-col">
            <i class="fas fa-sync fa-spin text-4xl text-kawanchat-blue mb-4"></i>
            <p class="text-gray-600">Memuat KawanChat...</p>
        </div>

        <div id="welcome-stage" class="stage flex-col justify-between">
            <div class="flex-grow flex flex-col justify-center items-center">
                <h2 class="text-3xl font-bold text-kawanchat-blue mb-6">üëã KawanChat</h2>
                <div id="sapaan-content" class="text-lg text-gray-700 max-w-sm mb-10 min-h-[120px]">
                    </div>
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner max-w-sm w-full hidden" id="tos-agreement">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="agree-tos" class="form-checkbox text-kawanchat-blue h-5 w-5 rounded">
                        <span class="text-sm text-gray-600">Saya setuju dengan Persyaratan & Ketentuan KawanChat.</span>
                    </label>
                </div>
            </div>
            <button id="next-welcome" class="w-full py-3 bg-kawanchat-blue text-white font-bold rounded-lg shadow-xl mb-4 hover:bg-kawanchat-light-blue transition disabled:opacity-50" disabled>
                Lanjut
            </button>
        </div>

        <div id="registration-stage" class="stage">
            <div class="flex-grow flex flex-col justify-center items-center">
                <div class="typing-text-container text-xl font-bold text-gray-800 mb-6 min-h-[40px]">
                    </div>
                
                <div id="input-name-area" class="w-full max-w-xs space-y-4 hidden">
                    <input type="text" id="reg-first-name" placeholder="Nama Depan" class="w-full p-3 border-b-2 border-gray-300 focus:border-kawanchat-blue focus:ring-0 text-lg rounded-t-lg">
                    <div id="name-feedback" class="text-md text-gray-600 mb-3 min-h-[25px]"></div>
                    <input type="text" id="reg-last-name" placeholder="Nama Belakang (Opsional)" class="w-full p-3 border-b-2 border-gray-300 focus:border-kawanchat-blue focus:ring-0 text-lg rounded-t-lg">
                    <select id="reg-gender" class="w-full p-3 border-b-2 border-gray-300 focus:border-kawanchat-blue focus:ring-0 text-lg bg-white rounded-t-lg">
                        <option value="" disabled selected>Pilih Jenis Kelamin</option>
                        <option value="L">Laki-laki</option>
                        <option value="P">Perempuan</option>
                        <option value="O">Lainnya</option>
                    </select>
                </div>

                <div id="input-phone-area" class="w-full max-w-xs space-y-4 hidden">
                    <p class="text-gray-500 mb-2" id="phone-icon">üôç‚Äç‚ôÇÔ∏è</p>
                    <div class="flex items-center border-b-2 border-gray-300 focus-within:border-kawanchat-blue rounded-t-lg bg-white">
                        <span class="p-3 text-lg text-gray-700">+62</span>
                        <input type="tel" id="reg-phone-number" placeholder="Nomor Telepon (ex: 812345678)" class="flex-grow p-3 text-lg focus:ring-0 border-none">
                    </div>
                </div>

                <div id="final-id-display" class="w-full max-w-xs space-y-4 hidden">
                    <div class="text-lg font-semibold text-kawanchat-blue mt-5 min-h-[40px]"></div>
                </div>

            </div>
            <button id="next-registration" class="w-full py-3 bg-kawanchat-blue text-white font-bold rounded-lg shadow-xl mb-4 hover:bg-kawanchat-light-blue transition disabled:opacity-50">
                Selanjutnya
            </button>
        </div>

        <div id="main-app" class="hidden flex-grow flex-col">
            <header class="header text-white p-4 flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <h1 id="app-title" class="text-xl font-bold">KawanChat</h1>
                    <div class="flex space-x-4 text-lg">
                        <i class="fas fa-search"></i>
                        <i class="fas fa-ellipsis-v"></i>
                    </div>
                </div>
                <p id="user-id-display" class="text-xs text-gray-200"></p>
            </header>

            <nav class="tab-bar flex justify-between px-2 text-gray-300 shadow-md">
                <button class="flex-1 py-3 text-sm tab-link active" data-tab="chat">OBROLAN</button>
                <button class="flex-1 py-3 text-sm tab-link" data-tab="status">STATUS</button>
                <button class="flex-1 py-3 text-sm tab-link" data-tab="calls">PANGGILAN</button>
                <button class="flex-1 py-3 text-sm tab-link" data-tab="contacts">KONTAK</button>
            </nav>

            <main class="flex-grow relative overflow-y-auto">

                <div id="chat-tab" class="tab-content active h-full flex flex-col">
                    <div id="active-chats-list" class="scroll-container flex flex-col p-4 space-y-2 flex-grow bg-white">
                        <div class="text-center text-gray-500 p-4">Klik tombol di bawah untuk memulai obrolan baru.</div>
                    </div>
                </div>

                <button id="new-chat-button" class="w-14 h-14 bg-kawanchat-blue text-white rounded-full flex items-center justify-center shadow-2xl hover:bg-kawanchat-light-blue transition duration-150">
                    <i class="fas fa-comment text-2xl"></i>
                </button>
                
                <div id="contacts-tab" class="tab-content hidden h-full flex flex-col p-4 bg-gray-50">
                    <h2 class="text-xl font-bold mb-4 text-kawanchat-blue">Daftar Kontak</h2>
                    <div id="contact-list" class="flex flex-col space-y-2 mb-4 scroll-container flex-grow overflow-y-auto">
                        <p class="text-gray-500 italic p-2">Memuat kontak...</p>
                    </div>
                    <div class="p-4 bg-white rounded-lg shadow-lg mt-4">
                        <h3 class="text-lg font-semibold mb-3">Tambah Kontak Baru</h3>
                        <input type="text" id="new-contact-id" placeholder="ID Pengguna (User ID) Kontak" class="w-full p-2 mb-2 rounded border border-gray-300 focus:ring-kawanchat-blue focus:border-kawanchat-blue">
                        <button id="add-contact-button" class="w-full bg-kawanchat-blue text-white py-2 rounded-lg font-semibold hover:bg-kawanchat-light-blue transition duration-150">
                            <i class="fas fa-user-plus mr-2"></i> Tambah
                        </button>
                    </div>
                </div>
                
                <div id="status-tab" class="tab-content hidden text-center p-10 bg-white">
                    <i class="fas fa-circle-notch text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">Fitur Status belum diimplementasikan.</p>
                </div>
                <div id="calls-tab" class="tab-content hidden text-center p-10 bg-white">
                    <i class="fas fa-phone-alt text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">Fitur Panggilan belum diimplementasikan.</p>
                </div>
            </main>
            
            <div id="chat-view" class="hidden absolute top-0 left-0 w-full h-full bg-white flex flex-col">
                <header id="chat-header" class="header text-white p-3 flex items-center shadow-md">
                    <button id="back-to-chats" class="mr-3 text-lg"><i class="fas fa-arrow-left"></i></button>
                    <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center mr-3 text-xl text-kawanchat-blue font-bold">
                         <i class="fas fa-user"></i>
                    </div>
                    <span id="chat-contact-name" class="text-lg font-semibold flex-grow"></span>
                    <i class="fas fa-ellipsis-v text-lg ml-4"></i>
                </header>
                
                <div id="messages-container" class="scroll-container flex flex-col p-4 space-y-2 flex-grow overflow-y-auto bg-kawanchat-bg">
                    </div>
                
                <div id="chat-message-area" class="p-3 flex items-center border-t border-gray-200">
                    <button id="emoji-button" class="text-xl text-gray-600 mr-2"><i class="far fa-smile"></i></button>
                    <input type="text" id="message-input" placeholder="Ketik pesan..." class="flex-grow p-3 rounded-full border bg-gray-100 focus:bg-white transition duration-150">
                    <button id="send-button" class="ml-2 w-10 h-10 bg-kawanchat-blue text-white rounded-full flex items-center justify-center shadow-lg hover:bg-kawanchat-light-blue transition duration-150">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>

        </div>

    </div>

    <script type="module">
        // --- Firebase Imports (Menggunakan CDN URL) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, updateDoc, doc, getDocs, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // --- Firebase Configuration (Sesuai yang Anda berikan) ---
        const firebaseConfig = {
            apiKey: "AIzaSyD9tO94PdmXnqSH4cMVLPbgcEyY1J266mQ",
            authDomain: "whatsapp-clone-web-9418e.firebaseapp.com",
            projectId: "whatsapp-clone-web-9418e",
            storageBucket: "whatsapp-clone-web-9418e.firebasestorage.app",
            messagingSenderId: "31927689655",
            appId: "1:31927689655:web:3e4da24d4237a7ffb08832",
            measurementId: "G-5624HP8XEX"
        };
        
        // Inisialisasi Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- Global State ---
        let currentUserId = null;
        let currentUserName = null;
        let currentChatContact = null; 
        let currentChatContactName = null; 
        let unsubscribeMessages = null; 
        const appId = 'kawanchat-v1'; 
        
        // --- DOM Elements (Stages) ---
        const loadingStage = document.getElementById('loading-stage'); // Tambahan loading
        const welcomeStage = document.getElementById('welcome-stage');
        const registrationStage = document.getElementById('registration-stage');
        const mainApp = document.getElementById('main-app');

        // Stage 1
        const sapaanContent = document.getElementById('sapaan-content');
        const nextWelcomeButton = document.getElementById('next-welcome');
        const tosAgreement = document.getElementById('tos-agreement');
        const agreeTos = document.getElementById('agree-tos');
        
        // Stage 2
        const typingTextContainer = registrationStage.querySelector('.typing-text-container');
        const nextRegistrationButton = document.getElementById('next-registration');
        const inputNameArea = document.getElementById('input-name-area');
        const regFirstName = document.getElementById('reg-first-name');
        const regLastName = document.getElementById('reg-last-name');
        const regGender = document.getElementById('reg-gender');
        const nameFeedback = document.getElementById('name-feedback');
        const inputPhoneArea = document.getElementById('input-phone-area');
        const regPhoneNumber = document.getElementById('reg-phone-number');
        const phoneIcon = document.getElementById('phone-icon'); // Icon Phone
        
        // Main App
        const userIdDisplay = document.getElementById('user-id-display');
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const activeChatsList = document.getElementById('active-chats-list');
        const contactList = document.getElementById('contact-list');
        const newChatButton = document.getElementById('new-chat-button');
        const newContactIdInput = document.getElementById('new-contact-id');
        const addContactButton = document.getElementById('add-contact-button');

        // Chat View
        const chatView = document.getElementById('chat-view');
        const backToChats = document.getElementById('back-to-chats');
        const chatContactName = document.getElementById('chat-contact-name');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatMessageArea = document.getElementById('chat-message-area');

        // --- Utility Functions ---

        /** Menampilkan teks dengan efek mengetik */
        const typeText = (element, text, callback = () => {}) => {
            element.innerHTML = '';
            let i = 0;
            const speed = 30; // Kecepatan mengetik
            const timer = setInterval(() => {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                } else {
                    clearInterval(timer);
                    callback();
                }
            }, speed);
        };

        const formatTime = (timestamp) => {
            if (!timestamp) return '...';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        };
        
        /** Menghapus listener pesan yang sedang berjalan */
        const unsubscribePreviousChat = () => {
            if (unsubscribeMessages) {
                unsubscribeMessages();
                unsubscribeMessages = null;
            }
        };

        /** Mengubah stage tampilan */
        const setStage = (stageId) => {
            [loadingStage, welcomeStage, registrationStage, mainApp].forEach(stage => {
                stage.classList.remove('active');
                stage.classList.add('hidden');
            });
            const target = document.getElementById(stageId);
            if (target) {
                target.classList.add('active');
                target.classList.remove('hidden');
            }
        };

        // --- STAGE 1 LOGIC (Welcome) ---

        let sapaanStep = 0;
        const sapaanTexts = [
            "Selamat datang di KawanChat! üëã",
            "Di KawanChat kamu bisa chat dengan teman lama maupun teman baru. Serasa gampang antar negara! üåê",
            "KawanChat adalah tempat yang aman untuk berbagi cerita. üîí",
            "Persahabatan sejati dimulai dari pesan sederhana. Mari kita mulai! üí¨"
        ];

        const nextSapaan = () => {
            nextWelcomeButton.disabled = true;
            if (sapaanStep < sapaanTexts.length) {
                typeText(sapaanContent, sapaanTexts[sapaanStep], () => {
                    sapaanStep++;
                    nextWelcomeButton.disabled = false;
                });
            } else if (sapaanStep === sapaanTexts.length) {
                // Tahap Persyaratan
                typeText(sapaanContent, "Satu langkah lagi! Silakan setujui persyaratan kami untuk melanjutkan:", () => {
                    tosAgreement.classList.remove('hidden');
                    nextWelcomeButton.disabled = !agreeTos.checked;
                    sapaanStep++;
                });
            } else {
                setStage('registration-stage');
                startRegistrationStage();
            }
        };

        agreeTos.addEventListener('change', () => {
            nextWelcomeButton.disabled = !agreeTos.checked;
        });

        // --- STAGE 2 LOGIC (Registration) ---

        let regStep = 1;

        const startRegistrationStage = async () => {
            nextRegistrationButton.disabled = true;
            await regStep1_Name();
        };

        const regStep1_Name = async () => {
            inputNameArea.classList.add('hidden');
            inputPhoneArea.classList.add('hidden');
            nextRegistrationButton.classList.remove('hidden');
            
            await new Promise(resolve => {
                typeText(typingTextContainer, "Kita belum kenalan nih! Kenalan dulu yuk! üôã", resolve);
            });

            inputNameArea.classList.remove('hidden');
            nextRegistrationButton.disabled = true;
            regFirstName.focus();
            regStep = 1;

            const nameInputHandler = () => {
                const name = regFirstName.value.trim();
                if (name.length > 0) {
                    nameFeedback.textContent = "Hmm kalo nama belakang boleh tau? (opsional)";
                    nextRegistrationButton.disabled = false;
                } else {
                    nameFeedback.textContent = "";
                    nextRegistrationButton.disabled = true;
                }
            };
            regFirstName.addEventListener('input', nameInputHandler);
            // Hapus listener agar tidak menumpuk di next step
            nextRegistrationButton.onclick = () => {
                regFirstName.removeEventListener('input', nameInputHandler);
                if (regFirstName.value.trim()) regStep2_Phone();
            };
        };

        const regStep2_Phone = async () => {
            inputNameArea.classList.add('hidden');
            nextRegistrationButton.disabled = true;

            const userName = regFirstName.value.trim();
            const lastName = regLastName.value.trim() || '';
            currentUserName = userName + (lastName ? ` ${lastName}` : '');
            
            await new Promise(resolve => {
                typeText(typingTextContainer, `Yey kita udh kenalan! Hi ${userName} üôå`, resolve);
            });
            await new Promise(resolve => setTimeout(resolve, 1500)); 
            
            await new Promise(resolve => {
                typeText(typingTextContainer, "Hmm boleh minta nomor mu untuk masuk ke dalam KawanChat? üìû", resolve);
            });

            inputPhoneArea.classList.remove('hidden');
            regStep = 2;

            regPhoneNumber.addEventListener('focus', () => phoneIcon.textContent = 'ü§¶‚Äç‚ôÇÔ∏è');
            regPhoneNumber.addEventListener('blur', () => phoneIcon.textContent = 'üôç‚Äç‚ôÇÔ∏è');
            const phoneInputHandler = () => {
                nextRegistrationButton.disabled = regPhoneNumber.value.length < 8; // Minimal 8 digit
            };
            regPhoneNumber.addEventListener('input', phoneInputHandler);
            regPhoneNumber.focus();

            nextRegistrationButton.onclick = () => {
                regPhoneNumber.removeEventListener('input', phoneInputHandler);
                if (regPhoneNumber.value.length >= 8) regStep3_Finalize();
            };
        };

        const regStep3_Finalize = async () => {
            inputPhoneArea.classList.add('hidden');
            nextRegistrationButton.classList.add('hidden');

            const fullPhoneNumber = '62' + regPhoneNumber.value.replace(/^0+|[^0-9]/g, ''); 

            await new Promise(resolve => {
                typeText(typingTextContainer, `Nomormu cantik banget ‚ú® kita ambil dari depan nomor mu yah!`, resolve);
            });
            await new Promise(resolve => setTimeout(resolve, 1500)); 

            const mockID = fullPhoneNumber.padEnd(11, '0'); 
            const prefix = mockID.substring(0, 5);
            
            await new Promise(resolve => {
                typeText(typingTextContainer, `Oke nomor depan mu ${prefix} kita tambahin jadi ${mockID}!`, resolve);
            });
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            const finalID = mockID.substring(mockID.length - 6); 
            
            await new Promise(resolve => {
                typeText(typingTextContainer, `Yey! ID mu udh di buat! Ini dia: ${finalID} üéâ`, resolve);
            });
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Lakukan Otentikasi dan Update Profile
            await signInAndSetProfile(currentUserName, finalID);

            await new Promise(resolve => {
                typeText(typingTextContainer, `Selamat datang di KawanChat, ${currentUserName.split(' ')[0]}!`, resolve);
            });
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            setStage('main-app');
            initializeMainApp();
        };

        const signInAndSetProfile = async (displayName, chatID) => {
            // Karena kita sudah signInAnonymously di tahap inisialisasi, kita gunakan user yang sudah ada
            const user = auth.currentUser;
            if (!user) {
                // Should not happen if flow is correct, but safe check
                throw new Error("User not authenticated.");
            }
            
            await updateProfile(user, {
                displayName: displayName
            });
            
            const userDocRef = doc(db, `/artifacts/${appId}/users/${user.uid}`);
            await setDoc(userDocRef, {
                name: displayName,
                id: chatID,
                phone: regPhoneNumber.value,
                gender: regGender.value,
                createdAt: serverTimestamp()
            }, { merge: true });
            
            currentUserId = user.uid;
        };

        // --- MAIN APP LOGIC (Chat) ---
        // (Fungsi loadContacts, startPrivateChat, renderMessages, listenForMessages, sendMessage, addContact, dan event handlers tab di sini, tidak diubah dari versi sebelumnya)
        
        const initializeMainApp = () => {
            // Tampilkan UI utama
            mainApp.classList.remove('hidden');
            userIdDisplay.textContent = `ID Anda: ${currentUserId.substring(0, 8)}`; // Tampilkan UID Firebase
            
            loadContacts();
            
            document.querySelector('.tab-link[data-tab="chat"]').click();
        };
        
        const loadContacts = async () => {
            if (!currentUserId) return;
            
            const contactsPath = `/artifacts/${appId}/users/${currentUserId}/contacts`;
            const q = collection(db, contactsPath);
            
            try {
                const querySnapshot = await getDocs(q);
                
                // 1. Render Contact List (Di tab KONTAK)
                contactList.innerHTML = '';
                if (querySnapshot.empty) {
                    contactList.innerHTML = `<p class="text-gray-500 italic p-2">Belum ada kontak. Tambahkan ID teman Anda di bawah.</p>`;
                }

                // 2. Render Active Chats List (Di tab OBROLAN)
                activeChatsList.innerHTML = '';
                if (querySnapshot.empty) {
                    activeChatsList.innerHTML = `<div class="text-center text-gray-500 p-4">Klik tombol di bawah untuk memulai obrolan baru.</div>`;
                }

                querySnapshot.forEach((doc) => {
                    const contactId = doc.id;
                    const contactData = doc.data();
                    const contactName = contactData.name || contactId.substring(0, 8);

                    const createContactItem = (isChatList = false) => {
                        const item = document.createElement('div');
                        item.className = 'contact-item flex items-center p-3 rounded-lg bg-white shadow-sm border border-gray-100 cursor-pointer hover:bg-gray-50 transition duration-100';
                        item.innerHTML = `
                            <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center mr-3 text-lg text-kawanchat-blue">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="font-semibold text-gray-800">${contactName}</p>
                                <p class="text-xs text-gray-500 truncate">${isChatList ? 'Pesan terakhir...' : `ID: ${contactId}`}</p>
                            </div>
                        `;
                        item.addEventListener('click', () => startPrivateChat(contactId, contactName));
                        return item;
                    };

                    contactList.appendChild(createContactItem(false));
                    activeChatsList.appendChild(createContactItem(true));
                });
                
            } catch (error) {
                console.error("Gagal memuat kontak:", error);
                contactList.innerHTML = `<p class="text-red-500 p-2">Error memuat kontak.</p>`;
                activeChatsList.innerHTML = `<p class="text-red-500 p-2">Error memuat daftar obrolan.</p>`;
            }
        };

        const startPrivateChat = (contactId, contactName) => {
            currentChatContact = contactId;
            currentChatContactName = contactName;
            
            document.querySelector('#main-app > main').classList.add('hidden');
            newChatButton.classList.add('hidden');
            chatView.classList.remove('hidden');
            chatMessageArea.style.display = 'flex'; 

            chatContactName.textContent = contactName;
            
            unsubscribePreviousChat(); 
            unsubscribeMessages = listenForMessages(contactId);
        };
        
        backToChats.addEventListener('click', () => {
            chatView.classList.add('hidden');
            chatMessageArea.style.display = 'none'; 
            document.querySelector('#main-app > main').classList.remove('hidden');
            newChatButton.classList.remove('hidden');
            
            unsubscribePreviousChat(); 
            currentChatContact = null;
            currentChatContactName = null;

            document.querySelector('.tab-link[data-tab="chat"]').click();
        });

        const renderMessages = (messages) => {
            messagesContainer.innerHTML = ''; 
            if (messages.length === 0) {
                messagesContainer.innerHTML = `<div class="text-center text-gray-500 p-4">Awal dari obrolan dengan ${currentChatContactName}.</div>`;
                return;
            }

            messages.forEach(msg => {
                const isSentByMe = msg.senderId === currentUserId;
                const alignmentClass = isSentByMe ? 'sent' : 'received';
                const displayName = isSentByMe ? currentUserName.split(' ')[0] : currentChatContactName.split(' ')[0]; 
                const nameColor = isSentByMe ? 'text-gray-700' : 'text-kawanchat-blue';

                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-bubble ${alignmentClass} shadow-md flex flex-col`;

                const nameSpan = document.createElement('span');
                nameSpan.className = `text-xs font-semibold mb-1 ${nameColor}`;
                nameSpan.textContent = displayName;
                messageDiv.appendChild(nameSpan);

                const contentSpan = document.createElement('span');
                contentSpan.className = 'text-sm text-black';
                contentSpan.textContent = msg.text;
                messageDiv.appendChild(contentSpan);

                const timeSpan = document.createElement('span');
                timeSpan.className = 'text-xs text-gray-500 self-end mt-1 ml-4';
                timeSpan.textContent = formatTime(msg.timestamp);
                messageDiv.appendChild(timeSpan);
                
                messagesContainer.appendChild(messageDiv);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        const listenForMessages = (contactId) => {
            const chatRoomId = [currentUserId, contactId].sort().join('_');
            const collectionPath = `/artifacts/${appId}/private/chats/${chatRoomId}/messages`;
            const messagesQuery = collection(db, collectionPath);
            
            return onSnapshot(messagesQuery, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                messages.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
                
                renderMessages(messages);
            }, (error) => {
                console.error("Gagal mendengarkan pesan:", error);
                messagesContainer.innerHTML = `<div class="text-center text-red-500 p-4">Gagal memuat pesan. Cek konsol.</div>`;
            });
        };

        const sendMessage = async (text) => {
            if (!text.trim() || !currentUserId || !currentChatContact) return;
            
            try {
                const chatRoomId = [currentUserId, currentChatContact].sort().join('_');
                const privateChatPath = `/artifacts/${appId}/private/chats/${chatRoomId}/messages`;
                const messageRef = collection(db, privateChatPath);

                const messageData = {
                    text: text.trim(),
                    timestamp: serverTimestamp(),
                    senderId: currentUserId,
                    senderName: currentUserName,
                    type: 'text'
                };

                await addDoc(messageRef, messageData);
                messageInput.value = ''; 
            } catch (error) {
                console.error("Gagal mengirim pesan: ", error);
            }
        };

        const addContact = async () => {
            const newContactId = newContactIdInput.value.trim();
            if (!newContactId || !currentUserId) return;

            // Logika sederhana: cek apakah ID yang dimasukkan cocok dengan 8 digit awal UID kita
            if (newContactId === currentUserId.substring(0, 8)) {
                 alert('Tidak bisa menambahkan ID Anda sendiri sebagai kontak!');
                 return;
            }
            
            try {
                const contactDocPath = `/artifacts/${appId}/users/${currentUserId}/contacts/${newContactId}`;
                await setDoc(doc(db, contactDocPath), { 
                    name: newContactId.substring(0, 8), 
                    addedAt: serverTimestamp() 
                }, { merge: true });

                newContactIdInput.value = '';
                await loadContacts(); 
                alert(`Kontak ${newContactId} berhasil ditambahkan!`);
            } catch (error) {
                console.error("Gagal menambahkan kontak: ", error);
                alert('Gagal menambahkan kontak. Pastikan ID benar.');
            }
        };
        
        sendButton.addEventListener('click', () => sendMessage(messageInput.value));
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(messageInput.value);
            }
        });
        addContactButton.addEventListener('click', addContact);
        newChatButton.addEventListener('click', () => {
            document.querySelector('.tab-link[data-tab="contacts"]').click();
        });

        tabLinks.forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabId = tab.getAttribute('data-tab');
                
                tabLinks.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.remove('hidden');
                    }
                });
                
                if (tabId === 'chat') {
                    newChatButton.classList.remove('hidden');
                } else {
                    newChatButton.classList.add('hidden');
                }
                
                if (tabId === 'contacts') {
                    loadContacts();
                }
            });
        });

        // --- INITIALIZATION ---
        
        // Coba sign in secara anonim terlebih dahulu untuk mendapatkan UID
        const initializeAuth = async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Gagal memulai sesi anonim:", error);
                setStage('welcome-stage');
                sapaanContent.textContent = "Error: Gagal terhubung ke server Firebase.";
                nextWelcomeButton.disabled = true;
            }
        };

        // Otentikasi dan Cek Registrasi
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // Jika belum ada user, coba sign in anonim
                await initializeAuth();
                return;
            }
            
            // User sudah ada (baru atau lama)
            currentUserId = user.uid;
            
            const userDocRef = doc(db, `/artifacts/${appId}/users/${user.uid}`);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                // User sudah registrasi, langsung ke Main App
                currentUserName = user.displayName || userDoc.data().name;
                setStage('main-app');
                initializeMainApp();
            } else {
                // User baru terautentikasi (anonim), mulai alur sapaan/registrasi
                setStage('welcome-stage');
                nextSapaan();
            }
        });

        // Start welcome flow
        nextWelcomeButton.addEventListener('click', nextSapaan);
        
    </script>
</body>
</html>
