<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Robux Top Up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        orderBy,
        limit,
        getDocs,
        updateDoc,
        doc,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        signOut,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // =======================================================
      // FIREBASE CONFIGURATION (DARI INPUT USER)
      // =======================================================
      const firebaseConfig = {
        apiKey: "AIzaSyBP-BfH2y4PnhDR4x0WZceIcu_AA2EKSO4",
        authDomain: "marstorekita-storebase.firebaseapp.com",
        projectId: "marstorekita-storebase",
        storageBucket: "marstorekita-storebase.firebasestorage.app",
        messagingSenderId: "655700298665",
        appId: "1:655700298665:web:ae6c703ba545283c2152b8",
        measurementId: "G-LERLQVVGRF",
      };

      // Inisialisasi Firebase Services
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const TRANSACTIONS_COLLECTION = "transactions";
      const transactionsCol = collection(db, TRANSACTIONS_COLLECTION);

      // =======================================================
      // AUTENTIKASI DAN UI HANDLER
      // =======================================================
      const dashboardContainer = document.getElementById("dashboard-container");
      const loginContainer = document.getElementById("login-container");
      const loginError = document.getElementById("loginError");

      function showDashboard() {
        loginContainer.classList.add("hidden");
        dashboardContainer.classList.remove("hidden");
        fetchTransactions(); // Mulai memuat data setelah login berhasil
      }

      function showLogin() {
        dashboardContainer.classList.add("hidden");
        loginContainer.classList.remove("hidden");
      }

      // --- Core Auth Listener ---
      onAuthStateChanged(auth, (user) => {
        if (user) {
          // Admin sudah login
          showDashboard();
        } else {
          // Admin belum login
          showLogin();
        }
      });
      // -------------------------

      window.handleLogin = async function () {
        const email = document.getElementById("adminEmail").value;
        const password = document.getElementById("adminPassword").value;
        loginError.textContent = ""; // Bersihkan error sebelumnya

        if (!email || !password) {
          loginError.textContent = "Email dan password harus diisi.";
          return;
        }

        try {
          await signInWithEmailAndPassword(auth, email, password);
          // AuthStateChanged listener akan memanggil showDashboard()
        } catch (error) {
          console.error("Login Error:", error.code);
          let errorMessage =
            "Gagal Login. Silakan cek email dan password Anda.";
          if (
            error.code === "auth/user-not-found" ||
            error.code === "auth/wrong-password"
          ) {
            errorMessage = "Kombinasi email/password salah.";
          }
          loginError.textContent = errorMessage;
        }
      };

      window.handleLogout = async function () {
        if (confirm("Yakin ingin keluar dari Dashboard?")) {
          await signOut(auth);
          // AuthStateChanged listener akan memanggil showLogin()
        }
      };

      // =======================================================
      // UTILITY FUNCTIONS & RENDER (UPDATED FOR MODULAR)
      // =======================================================

      function formatRupiah(number) {
        if (isNaN(number) || number === null) return "Rp 0";
        return "Rp " + number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      }

      function formatDate(timestamp) {
        if (!timestamp || !timestamp.toDate) return "-";
        const date = timestamp.toDate();
        return (
          date.toLocaleTimeString("id-ID", {
            hour: "2-digit",
            minute: "2-digit",
          }) +
          ", " +
          date.toLocaleDateString("id-ID", { day: "2-digit", month: "short" })
        );
      }

      function getStatusBadge(status) {
        return `<span class="status-badge status-${status}">${status}</span>`;
      }

      async function fetchTransactions() {
        const tableBody = document.getElementById("transactionsTableBody");
        const loadingIndicator = document.getElementById("loadingIndicator");
        const noDataMessage = document.getElementById("noDataMessage");
        const refreshBtn = document.getElementById("refreshBtn");

        tableBody.innerHTML = "";
        loadingIndicator.classList.remove("hidden");
        noDataMessage.classList.add("hidden");
        refreshBtn.disabled = true;

        try {
          // Modular Firestore: getDocs()
          const q = transactionsCol;
          const snapshot = await getDocs(q);

          if (snapshot.empty) {
            noDataMessage.classList.remove("hidden");
            return;
          }

          snapshot.docs.forEach((doc) => {
            renderTransactionRow(doc.id, doc.data());
          });
        } catch (error) {
          console.error("Error fetching transactions: ", error);
          tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-red-600">Gagal memuat data: ${error.message}</td></tr>`;
        } finally {
          loadingIndicator.classList.add("hidden");
          refreshBtn.disabled = false;
        }
      }

      window.fetchTransactions = fetchTransactions; // expose to window for button click

      function renderTransactionRow(id, data) {
        const tableBody = document.getElementById("transactionsTableBody");
        const row = document.createElement("tr");

        row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${id.substring(
                  0,
                  8
                )}...</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(
                  data.createdAt
                )}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">${
                  data.username
                }</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600">${
                  data.netRobux
                } R$</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-700 font-medium">${
                  data.grossGamepassPrice
                } R$</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatRupiah(
                  data.totalPriceIDR
                )}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm">
                    ${getStatusBadge(data.transactionStatus)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button 
                        onclick="updateStatus('${id}', 'Processing')" 
                        class="action-button bg-yellow-500 text-white p-2 rounded mr-2"
                        title="Tandai Sedang Diproses"
                    >
                        <i class="fas fa-redo"></i>
                    </button>
                    <button 
                        onclick="updateStatus('${id}', 'Completed')" 
                        class="action-button bg-green-600 text-white p-2 rounded"
                        title="Tandai Selesai"
                    >
                        <i class="fas fa-check"></i>
                    </button>
                </td>
            `;
        tableBody.appendChild(row);
      }

      // =======================================================
      // ACTION: UPDATE STATUS (MODULAR)
      // =======================================================
      window.updateStatus = async function (docId, newStatus) {
        if (
          !confirm(
            `Yakin ingin mengubah status transaksi ${docId.substring(
              0,
              8
            )}... menjadi "${newStatus}"?`
          )
        ) {
          return;
        }

        try {
          // Modular Firestore: doc() dan updateDoc()
          const transactionRef = doc(db, TRANSACTIONS_COLLECTION, docId);
          await updateDoc(transactionRef, {
            transactionStatus: newStatus,
            updatedAt: serverTimestamp(), // Modular Firestore: serverTimestamp()
          });
          alert(
            `Status transaksi ${docId.substring(
              0,
              8
            )}... berhasil diubah menjadi ${newStatus}.`
          );
          fetchTransactions();
        } catch (error) {
          console.error("Error updating status: ", error);
          alert("Gagal memperbarui status. Cek konsol untuk detail error.");
        }
      };
    </script>

    <style>
      /* ... CSS SAMA DENGAN SEBELUMNYA ... */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      .status-badge {
        padding: 4px 10px;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
      }
      .status-Pending {
        background-color: #fee2e2;
        color: #ef4444;
      }
      .status-Processing {
        background-color: #bfdbfe;
        color: #1d4ed8;
      }
      .status-Completed {
        background-color: #d1fae5;
        color: #065f46;
      }
      .status-Failed {
        background-color: #fef3c7;
        color: #b45309;
      }
      .action-button:hover {
        opacity: 0.8;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <div
      id="login-container"
      class="min-h-screen flex items-center justify-center bg-gray-50 hidden"
    >
      <div class="w-full max-w-md">
        <div class="bg-white shadow-xl rounded-2xl px-8 pt-6 pb-8 mb-4">
          <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">
            <i class="fas fa-lock text-red-600 mr-2"></i>Admin Login
          </h2>
          <div class="mb-4">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="adminEmail"
            >
              Email
            </label>
            <input
              class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
              id="adminEmail"
              type="email"
              placeholder="admin@domain.com"
            />
          </div>
          <div class="mb-6">
            <label
              class="block text-gray-700 text-sm font-bold mb-2"
              for="adminPassword"
            >
              Password
            </label>
            <input
              class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline"
              id="adminPassword"
              type="password"
              placeholder="********"
            />
            <p id="loginError" class="text-red-500 text-xs italic"></p>
          </div>
          <div class="flex items-center justify-center">
            <button
              class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 w-full"
              type="button"
              onclick="handleLogin()"
            >
              <i class="fas fa-sign-in-alt mr-2"></i> Masuk ke Dashboard
            </button>
          </div>
        </div>
        <p class="text-center text-gray-500 text-xs">
          &copy; 2024 Admin Panel. Data aman.
        </p>
      </div>
    </div>

    <div id="dashboard-container" class="hidden">
      <header class="bg-gray-800 text-white shadow-lg">
        <div
          class="container mx-auto px-4 py-4 flex justify-between items-center"
        >
          <h1 class="text-2xl font-bold">
            <i class="fas fa-chart-line mr-2"></i>Admin Dashboard
          </h1>
          <button
            id="logoutBtn"
            onclick="handleLogout()"
            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition"
          >
            <i class="fas fa-sign-out-alt mr-2"></i>Logout
          </button>
        </div>
      </header>

      <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
          <div class="flex justify-between items-center mb-6 border-b pb-4">
            <h2 class="text-xl font-semibold text-gray-800">
              Daftar Transaksi Baru
            </h2>
            <button
              id="refreshBtn"
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition disabled:bg-blue-400"
              onclick="fetchTransactions()"
            >
              <i class="fas fa-sync-alt mr-2"></i>Refresh Data
            </button>
          </div>

          <div id="loadingIndicator" class="text-center py-10 hidden">
            <div
              class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto mb-3"
            ></div>
            <p class="text-gray-600">Memuat data transaksi...</p>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ID
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Waktu
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Username
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Net Robux
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Gamepass Price
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Total Bayar
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Status
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Aksi
                  </th>
                </tr>
              </thead>
              <tbody
                id="transactionsTableBody"
                class="bg-white divide-y divide-gray-200"
              >
                <tr>
                  <td colspan="8" class="text-center py-4 text-gray-500">
                    Memuat...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <p id="noDataMessage" class="text-center py-4 text-gray-500 hidden">
            Tidak ada transaksi ditemukan.
          </p>
        </div>
      </main>
    </div>
  </body>
</html>
